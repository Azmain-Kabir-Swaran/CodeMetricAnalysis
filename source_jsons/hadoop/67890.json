{
  "origin": "codeshovel",
  "repositoryName": "hadoop",
  "repositoryPath": "/home/shaiful/research/codeshovel/codeshovel-projects/hadoop/.git",
  "startCommitName": "HEAD",
  "sourceFileName": "DistCpSync.java",
  "functionName": "sync",
  "functionId": "sync",
  "sourceFilePath": "hadoop-tools/hadoop-distcp/src/main/java/org/apache/hadoop/tools/DistCpSync.java",
  "functionStartLine": 151,
  "functionEndLine": 186,
  "numCommitsSeen": 15,
  "timeTaken": 3297,
  "changeHistory": [
    "26172a94d6431e70d7fe15d66be9a7e195f79f60",
    "8650cc84f20e7d8c32dcdcd91c94372d476e2276",
    "0bc6d37f3c1e7c2a8682dffa95461a884bd6ba17",
    "412c4c9a342b73bf1c1a7f43ea91245cbf94d02d",
    "0bc15cb6e60dc60885234e01dec1c7cb4557a926",
    "4c097e473bb1f18d1510deb61bae2bcb8c156f18",
    "75cb1d42abec54ef5484636e020949ceebe189e9",
    "ed70fa142cabdbc1065e4dbbc95e99c8850c4751"
  ],
  "changeHistoryShort": {
    "26172a94d6431e70d7fe15d66be9a7e195f79f60": "Ybodychange",
    "8650cc84f20e7d8c32dcdcd91c94372d476e2276": "Ybodychange",
    "0bc6d37f3c1e7c2a8682dffa95461a884bd6ba17": "Ybodychange",
    "412c4c9a342b73bf1c1a7f43ea91245cbf94d02d": "Ybodychange",
    "0bc15cb6e60dc60885234e01dec1c7cb4557a926": "Ymultichange(Yparameterchange,Ymodifierchange,Ybodychange)",
    "4c097e473bb1f18d1510deb61bae2bcb8c156f18": "Ybodychange",
    "75cb1d42abec54ef5484636e020949ceebe189e9": "Ybodychange",
    "ed70fa142cabdbc1065e4dbbc95e99c8850c4751": "Yintroduced"
  },
  "changeHistoryDetails": {
    "26172a94d6431e70d7fe15d66be9a7e195f79f60": {
      "type": "Ybodychange",
      "commitMessage": "HADOOP-14267. Make DistCpOptions immutable. Contributed by Mingliang Liu\n",
      "commitDate": "31/03/17 8:04 PM",
      "commitName": "26172a94d6431e70d7fe15d66be9a7e195f79f60",
      "commitAuthor": "Mingliang Liu",
      "commitDateOld": "15/11/16 10:57 AM",
      "commitNameOld": "5af572b6443715b7a741296c1bd520a1840f9a7c",
      "commitAuthorOld": "Mingliang Liu",
      "daysBetweenCommits": 136.34,
      "commitsBetweenForRepo": 740,
      "commitsBetweenForFile": 1,
      "diff": "@@ -1,36 +1,36 @@\n   public boolean sync() throws IOException {\n     if (!preSyncCheck()) {\n       return false;\n     }\n \n     if (!getAllDiffs()) {\n       return false;\n     }\n \n-    List\u003cPath\u003e sourcePaths \u003d inputOptions.getSourcePaths();\n+    List\u003cPath\u003e sourcePaths \u003d context.getSourcePaths();\n     final Path sourceDir \u003d sourcePaths.get(0);\n-    final Path targetDir \u003d inputOptions.getTargetPath();\n+    final Path targetDir \u003d context.getTargetPath();\n     final FileSystem tfs \u003d targetDir.getFileSystem(conf);\n     final DistributedFileSystem targetFs \u003d (DistributedFileSystem) tfs;\n \n     Path tmpDir \u003d null;\n     try {\n       tmpDir \u003d createTargetTmpDir(targetFs, targetDir);\n       DiffInfo[] renameAndDeleteDiffs \u003d\n           getRenameAndDeleteDiffsForSync(targetDir);\n       if (renameAndDeleteDiffs.length \u003e 0) {\n         // do the real sync work: deletion and rename\n         syncDiff(renameAndDeleteDiffs, targetFs, tmpDir);\n       }\n       return true;\n     } catch (Exception e) {\n       DistCp.LOG.warn(\"Failed to use snapshot diff for distcp\", e);\n       return false;\n     } finally {\n       deleteTargetTmpDir(targetFs, tmpDir);\n       // TODO: since we have tmp directory, we can support \"undo\" with failures\n       // set the source path using the snapshot path\n-      inputOptions.setSourcePaths(Arrays.asList(getSnapshotPath(sourceDir,\n-          inputOptions.getToSnapshot())));\n+      context.setSourcePaths(Arrays.asList(getSnapshotPath(sourceDir,\n+          context.getToSnapshot())));\n     }\n   }\n\\ No newline at end of file\n",
      "actualSource": "  public boolean sync() throws IOException {\n    if (!preSyncCheck()) {\n      return false;\n    }\n\n    if (!getAllDiffs()) {\n      return false;\n    }\n\n    List\u003cPath\u003e sourcePaths \u003d context.getSourcePaths();\n    final Path sourceDir \u003d sourcePaths.get(0);\n    final Path targetDir \u003d context.getTargetPath();\n    final FileSystem tfs \u003d targetDir.getFileSystem(conf);\n    final DistributedFileSystem targetFs \u003d (DistributedFileSystem) tfs;\n\n    Path tmpDir \u003d null;\n    try {\n      tmpDir \u003d createTargetTmpDir(targetFs, targetDir);\n      DiffInfo[] renameAndDeleteDiffs \u003d\n          getRenameAndDeleteDiffsForSync(targetDir);\n      if (renameAndDeleteDiffs.length \u003e 0) {\n        // do the real sync work: deletion and rename\n        syncDiff(renameAndDeleteDiffs, targetFs, tmpDir);\n      }\n      return true;\n    } catch (Exception e) {\n      DistCp.LOG.warn(\"Failed to use snapshot diff for distcp\", e);\n      return false;\n    } finally {\n      deleteTargetTmpDir(targetFs, tmpDir);\n      // TODO: since we have tmp directory, we can support \"undo\" with failures\n      // set the source path using the snapshot path\n      context.setSourcePaths(Arrays.asList(getSnapshotPath(sourceDir,\n          context.getToSnapshot())));\n    }\n  }",
      "path": "hadoop-tools/hadoop-distcp/src/main/java/org/apache/hadoop/tools/DistCpSync.java",
      "extendedDetails": {}
    },
    "8650cc84f20e7d8c32dcdcd91c94372d476e2276": {
      "type": "Ybodychange",
      "commitMessage": "HDFS-9820. Improve distcp to support efficient restore to an earlier snapshot. Contributed by Yongjun Zhang.\n",
      "commitDate": "19/10/16 5:37 PM",
      "commitName": "8650cc84f20e7d8c32dcdcd91c94372d476e2276",
      "commitAuthor": "Yongjun Zhang",
      "commitDateOld": "17/10/16 10:47 PM",
      "commitNameOld": "0bc6d37f3c1e7c2a8682dffa95461a884bd6ba17",
      "commitAuthorOld": "Yongjun Zhang",
      "daysBetweenCommits": 1.78,
      "commitsBetweenForRepo": 15,
      "commitsBetweenForFile": 1,
      "diff": "@@ -1,35 +1,36 @@\n   public boolean sync() throws IOException {\n     if (!preSyncCheck()) {\n       return false;\n     }\n \n     if (!getAllDiffs()) {\n       return false;\n     }\n \n     List\u003cPath\u003e sourcePaths \u003d inputOptions.getSourcePaths();\n     final Path sourceDir \u003d sourcePaths.get(0);\n     final Path targetDir \u003d inputOptions.getTargetPath();\n     final FileSystem tfs \u003d targetDir.getFileSystem(conf);\n     final DistributedFileSystem targetFs \u003d (DistributedFileSystem) tfs;\n \n     Path tmpDir \u003d null;\n     try {\n       tmpDir \u003d createTargetTmpDir(targetFs, targetDir);\n-      DiffInfo[] renameAndDeleteDiffs \u003d getRenameAndDeleteDiffs(targetDir);\n+      DiffInfo[] renameAndDeleteDiffs \u003d\n+          getRenameAndDeleteDiffsForSync(targetDir);\n       if (renameAndDeleteDiffs.length \u003e 0) {\n         // do the real sync work: deletion and rename\n         syncDiff(renameAndDeleteDiffs, targetFs, tmpDir);\n       }\n       return true;\n     } catch (Exception e) {\n       DistCp.LOG.warn(\"Failed to use snapshot diff for distcp\", e);\n       return false;\n     } finally {\n       deleteTargetTmpDir(targetFs, tmpDir);\n       // TODO: since we have tmp directory, we can support \"undo\" with failures\n       // set the source path using the snapshot path\n-      inputOptions.setSourcePaths(Arrays.asList(getSourceSnapshotPath(sourceDir,\n+      inputOptions.setSourcePaths(Arrays.asList(getSnapshotPath(sourceDir,\n           inputOptions.getToSnapshot())));\n     }\n   }\n\\ No newline at end of file\n",
      "actualSource": "  public boolean sync() throws IOException {\n    if (!preSyncCheck()) {\n      return false;\n    }\n\n    if (!getAllDiffs()) {\n      return false;\n    }\n\n    List\u003cPath\u003e sourcePaths \u003d inputOptions.getSourcePaths();\n    final Path sourceDir \u003d sourcePaths.get(0);\n    final Path targetDir \u003d inputOptions.getTargetPath();\n    final FileSystem tfs \u003d targetDir.getFileSystem(conf);\n    final DistributedFileSystem targetFs \u003d (DistributedFileSystem) tfs;\n\n    Path tmpDir \u003d null;\n    try {\n      tmpDir \u003d createTargetTmpDir(targetFs, targetDir);\n      DiffInfo[] renameAndDeleteDiffs \u003d\n          getRenameAndDeleteDiffsForSync(targetDir);\n      if (renameAndDeleteDiffs.length \u003e 0) {\n        // do the real sync work: deletion and rename\n        syncDiff(renameAndDeleteDiffs, targetFs, tmpDir);\n      }\n      return true;\n    } catch (Exception e) {\n      DistCp.LOG.warn(\"Failed to use snapshot diff for distcp\", e);\n      return false;\n    } finally {\n      deleteTargetTmpDir(targetFs, tmpDir);\n      // TODO: since we have tmp directory, we can support \"undo\" with failures\n      // set the source path using the snapshot path\n      inputOptions.setSourcePaths(Arrays.asList(getSnapshotPath(sourceDir,\n          inputOptions.getToSnapshot())));\n    }\n  }",
      "path": "hadoop-tools/hadoop-distcp/src/main/java/org/apache/hadoop/tools/DistCpSync.java",
      "extendedDetails": {}
    },
    "0bc6d37f3c1e7c2a8682dffa95461a884bd6ba17": {
      "type": "Ybodychange",
      "commitMessage": "Revert \"HDFS-9820. Improve distcp to support efficient restore to an earlier snapshot. Contributed by Yongjun Zhang.\"\n\nThis reverts commit 412c4c9a342b73bf1c1a7f43ea91245cbf94d02d.\n",
      "commitDate": "17/10/16 10:47 PM",
      "commitName": "0bc6d37f3c1e7c2a8682dffa95461a884bd6ba17",
      "commitAuthor": "Yongjun Zhang",
      "commitDateOld": "17/10/16 11:04 AM",
      "commitNameOld": "412c4c9a342b73bf1c1a7f43ea91245cbf94d02d",
      "commitAuthorOld": "Yongjun Zhang",
      "daysBetweenCommits": 0.49,
      "commitsBetweenForRepo": 7,
      "commitsBetweenForFile": 1,
      "diff": "@@ -1,36 +1,35 @@\n   public boolean sync() throws IOException {\n     if (!preSyncCheck()) {\n       return false;\n     }\n \n     if (!getAllDiffs()) {\n       return false;\n     }\n \n     List\u003cPath\u003e sourcePaths \u003d inputOptions.getSourcePaths();\n     final Path sourceDir \u003d sourcePaths.get(0);\n     final Path targetDir \u003d inputOptions.getTargetPath();\n     final FileSystem tfs \u003d targetDir.getFileSystem(conf);\n     final DistributedFileSystem targetFs \u003d (DistributedFileSystem) tfs;\n \n     Path tmpDir \u003d null;\n     try {\n       tmpDir \u003d createTargetTmpDir(targetFs, targetDir);\n-      DiffInfo[] renameAndDeleteDiffs \u003d\n-          getRenameAndDeleteDiffsForSync(targetDir);\n+      DiffInfo[] renameAndDeleteDiffs \u003d getRenameAndDeleteDiffs(targetDir);\n       if (renameAndDeleteDiffs.length \u003e 0) {\n         // do the real sync work: deletion and rename\n         syncDiff(renameAndDeleteDiffs, targetFs, tmpDir);\n       }\n       return true;\n     } catch (Exception e) {\n       DistCp.LOG.warn(\"Failed to use snapshot diff for distcp\", e);\n       return false;\n     } finally {\n       deleteTargetTmpDir(targetFs, tmpDir);\n       // TODO: since we have tmp directory, we can support \"undo\" with failures\n       // set the source path using the snapshot path\n-      inputOptions.setSourcePaths(Arrays.asList(getSnapshotPath(sourceDir,\n+      inputOptions.setSourcePaths(Arrays.asList(getSourceSnapshotPath(sourceDir,\n           inputOptions.getToSnapshot())));\n     }\n   }\n\\ No newline at end of file\n",
      "actualSource": "  public boolean sync() throws IOException {\n    if (!preSyncCheck()) {\n      return false;\n    }\n\n    if (!getAllDiffs()) {\n      return false;\n    }\n\n    List\u003cPath\u003e sourcePaths \u003d inputOptions.getSourcePaths();\n    final Path sourceDir \u003d sourcePaths.get(0);\n    final Path targetDir \u003d inputOptions.getTargetPath();\n    final FileSystem tfs \u003d targetDir.getFileSystem(conf);\n    final DistributedFileSystem targetFs \u003d (DistributedFileSystem) tfs;\n\n    Path tmpDir \u003d null;\n    try {\n      tmpDir \u003d createTargetTmpDir(targetFs, targetDir);\n      DiffInfo[] renameAndDeleteDiffs \u003d getRenameAndDeleteDiffs(targetDir);\n      if (renameAndDeleteDiffs.length \u003e 0) {\n        // do the real sync work: deletion and rename\n        syncDiff(renameAndDeleteDiffs, targetFs, tmpDir);\n      }\n      return true;\n    } catch (Exception e) {\n      DistCp.LOG.warn(\"Failed to use snapshot diff for distcp\", e);\n      return false;\n    } finally {\n      deleteTargetTmpDir(targetFs, tmpDir);\n      // TODO: since we have tmp directory, we can support \"undo\" with failures\n      // set the source path using the snapshot path\n      inputOptions.setSourcePaths(Arrays.asList(getSourceSnapshotPath(sourceDir,\n          inputOptions.getToSnapshot())));\n    }\n  }",
      "path": "hadoop-tools/hadoop-distcp/src/main/java/org/apache/hadoop/tools/DistCpSync.java",
      "extendedDetails": {}
    },
    "412c4c9a342b73bf1c1a7f43ea91245cbf94d02d": {
      "type": "Ybodychange",
      "commitMessage": "HDFS-9820. Improve distcp to support efficient restore to an earlier snapshot. Contributed by Yongjun Zhang.\n",
      "commitDate": "17/10/16 11:04 AM",
      "commitName": "412c4c9a342b73bf1c1a7f43ea91245cbf94d02d",
      "commitAuthor": "Yongjun Zhang",
      "commitDateOld": "26/04/16 4:08 PM",
      "commitNameOld": "959a28dd1216dfac78d05b438828e8503108d963",
      "commitAuthorOld": "Yongjun Zhang",
      "daysBetweenCommits": 173.79,
      "commitsBetweenForRepo": 1276,
      "commitsBetweenForFile": 1,
      "diff": "@@ -1,35 +1,36 @@\n   public boolean sync() throws IOException {\n     if (!preSyncCheck()) {\n       return false;\n     }\n \n     if (!getAllDiffs()) {\n       return false;\n     }\n \n     List\u003cPath\u003e sourcePaths \u003d inputOptions.getSourcePaths();\n     final Path sourceDir \u003d sourcePaths.get(0);\n     final Path targetDir \u003d inputOptions.getTargetPath();\n     final FileSystem tfs \u003d targetDir.getFileSystem(conf);\n     final DistributedFileSystem targetFs \u003d (DistributedFileSystem) tfs;\n \n     Path tmpDir \u003d null;\n     try {\n       tmpDir \u003d createTargetTmpDir(targetFs, targetDir);\n-      DiffInfo[] renameAndDeleteDiffs \u003d getRenameAndDeleteDiffs(targetDir);\n+      DiffInfo[] renameAndDeleteDiffs \u003d\n+          getRenameAndDeleteDiffsForSync(targetDir);\n       if (renameAndDeleteDiffs.length \u003e 0) {\n         // do the real sync work: deletion and rename\n         syncDiff(renameAndDeleteDiffs, targetFs, tmpDir);\n       }\n       return true;\n     } catch (Exception e) {\n       DistCp.LOG.warn(\"Failed to use snapshot diff for distcp\", e);\n       return false;\n     } finally {\n       deleteTargetTmpDir(targetFs, tmpDir);\n       // TODO: since we have tmp directory, we can support \"undo\" with failures\n       // set the source path using the snapshot path\n-      inputOptions.setSourcePaths(Arrays.asList(getSourceSnapshotPath(sourceDir,\n+      inputOptions.setSourcePaths(Arrays.asList(getSnapshotPath(sourceDir,\n           inputOptions.getToSnapshot())));\n     }\n   }\n\\ No newline at end of file\n",
      "actualSource": "  public boolean sync() throws IOException {\n    if (!preSyncCheck()) {\n      return false;\n    }\n\n    if (!getAllDiffs()) {\n      return false;\n    }\n\n    List\u003cPath\u003e sourcePaths \u003d inputOptions.getSourcePaths();\n    final Path sourceDir \u003d sourcePaths.get(0);\n    final Path targetDir \u003d inputOptions.getTargetPath();\n    final FileSystem tfs \u003d targetDir.getFileSystem(conf);\n    final DistributedFileSystem targetFs \u003d (DistributedFileSystem) tfs;\n\n    Path tmpDir \u003d null;\n    try {\n      tmpDir \u003d createTargetTmpDir(targetFs, targetDir);\n      DiffInfo[] renameAndDeleteDiffs \u003d\n          getRenameAndDeleteDiffsForSync(targetDir);\n      if (renameAndDeleteDiffs.length \u003e 0) {\n        // do the real sync work: deletion and rename\n        syncDiff(renameAndDeleteDiffs, targetFs, tmpDir);\n      }\n      return true;\n    } catch (Exception e) {\n      DistCp.LOG.warn(\"Failed to use snapshot diff for distcp\", e);\n      return false;\n    } finally {\n      deleteTargetTmpDir(targetFs, tmpDir);\n      // TODO: since we have tmp directory, we can support \"undo\" with failures\n      // set the source path using the snapshot path\n      inputOptions.setSourcePaths(Arrays.asList(getSnapshotPath(sourceDir,\n          inputOptions.getToSnapshot())));\n    }\n  }",
      "path": "hadoop-tools/hadoop-distcp/src/main/java/org/apache/hadoop/tools/DistCpSync.java",
      "extendedDetails": {}
    },
    "0bc15cb6e60dc60885234e01dec1c7cb4557a926": {
      "type": "Ymultichange(Yparameterchange,Ymodifierchange,Ybodychange)",
      "commitMessage": "HDFS-8828. Utilize Snapshot diff report to build diff copy list in distcp. (Yufei Gu via Yongjun Zhang)\n",
      "commitDate": "20/08/15 8:02 AM",
      "commitName": "0bc15cb6e60dc60885234e01dec1c7cb4557a926",
      "commitAuthor": "Yongjun Zhang",
      "subchanges": [
        {
          "type": "Yparameterchange",
          "commitMessage": "HDFS-8828. Utilize Snapshot diff report to build diff copy list in distcp. (Yufei Gu via Yongjun Zhang)\n",
          "commitDate": "20/08/15 8:02 AM",
          "commitName": "0bc15cb6e60dc60885234e01dec1c7cb4557a926",
          "commitAuthor": "Yongjun Zhang",
          "commitDateOld": "15/04/15 12:37 PM",
          "commitNameOld": "4c097e473bb1f18d1510deb61bae2bcb8c156f18",
          "commitAuthorOld": "Jing Zhao",
          "daysBetweenCommits": 126.81,
          "commitsBetweenForRepo": 958,
          "commitsBetweenForFile": 1,
          "diff": "@@ -1,52 +1,35 @@\n-  static boolean sync(DistCpOptions inputOptions, Configuration conf)\n-      throws IOException {\n-    List\u003cPath\u003e sourcePaths \u003d inputOptions.getSourcePaths();\n-    if (sourcePaths.size() !\u003d 1) {\n-      // we only support one source dir which must be a snapshottable directory\n-      throw new IllegalArgumentException(sourcePaths.size()\n-          + \" source paths are provided\");\n-    }\n-    final Path sourceDir \u003d sourcePaths.get(0);\n-    final Path targetDir \u003d inputOptions.getTargetPath();\n-\n-    final FileSystem sfs \u003d sourceDir.getFileSystem(conf);\n-    final FileSystem tfs \u003d targetDir.getFileSystem(conf);\n-    // currently we require both the source and the target file system are\n-    // DistributedFileSystem.\n-    if (!(sfs instanceof DistributedFileSystem) ||\n-        !(tfs instanceof DistributedFileSystem)) {\n-      throw new IllegalArgumentException(\"The FileSystems needs to\" +\n-          \" be DistributedFileSystem for using snapshot-diff-based distcp\");\n-    }\n-    final DistributedFileSystem sourceFs \u003d (DistributedFileSystem) sfs;\n-    final DistributedFileSystem targetFs\u003d (DistributedFileSystem) tfs;\n-\n-    // make sure targetFS has no change between from and the current states\n-    if (!checkNoChange(inputOptions, targetFs, targetDir)) {\n-      // set the source path using the snapshot path\n-      inputOptions.setSourcePaths(Arrays.asList(getSourceSnapshotPath(sourceDir,\n-          inputOptions.getToSnapshot())));\n+  public boolean sync() throws IOException {\n+    if (!preSyncCheck()) {\n       return false;\n     }\n \n+    if (!getAllDiffs()) {\n+      return false;\n+    }\n+\n+    List\u003cPath\u003e sourcePaths \u003d inputOptions.getSourcePaths();\n+    final Path sourceDir \u003d sourcePaths.get(0);\n+    final Path targetDir \u003d inputOptions.getTargetPath();\n+    final FileSystem tfs \u003d targetDir.getFileSystem(conf);\n+    final DistributedFileSystem targetFs \u003d (DistributedFileSystem) tfs;\n+\n     Path tmpDir \u003d null;\n     try {\n       tmpDir \u003d createTargetTmpDir(targetFs, targetDir);\n-      DiffInfo[] diffs \u003d getDiffs(inputOptions, sourceFs, sourceDir, targetDir);\n-      if (diffs \u003d\u003d null) {\n-        return false;\n+      DiffInfo[] renameAndDeleteDiffs \u003d getRenameAndDeleteDiffs(targetDir);\n+      if (renameAndDeleteDiffs.length \u003e 0) {\n+        // do the real sync work: deletion and rename\n+        syncDiff(renameAndDeleteDiffs, targetFs, tmpDir);\n       }\n-      // do the real sync work: deletion and rename\n-      syncDiff(diffs, targetFs, tmpDir);\n       return true;\n     } catch (Exception e) {\n       DistCp.LOG.warn(\"Failed to use snapshot diff for distcp\", e);\n       return false;\n     } finally {\n       deleteTargetTmpDir(targetFs, tmpDir);\n       // TODO: since we have tmp directory, we can support \"undo\" with failures\n       // set the source path using the snapshot path\n       inputOptions.setSourcePaths(Arrays.asList(getSourceSnapshotPath(sourceDir,\n           inputOptions.getToSnapshot())));\n     }\n   }\n\\ No newline at end of file\n",
          "actualSource": "  public boolean sync() throws IOException {\n    if (!preSyncCheck()) {\n      return false;\n    }\n\n    if (!getAllDiffs()) {\n      return false;\n    }\n\n    List\u003cPath\u003e sourcePaths \u003d inputOptions.getSourcePaths();\n    final Path sourceDir \u003d sourcePaths.get(0);\n    final Path targetDir \u003d inputOptions.getTargetPath();\n    final FileSystem tfs \u003d targetDir.getFileSystem(conf);\n    final DistributedFileSystem targetFs \u003d (DistributedFileSystem) tfs;\n\n    Path tmpDir \u003d null;\n    try {\n      tmpDir \u003d createTargetTmpDir(targetFs, targetDir);\n      DiffInfo[] renameAndDeleteDiffs \u003d getRenameAndDeleteDiffs(targetDir);\n      if (renameAndDeleteDiffs.length \u003e 0) {\n        // do the real sync work: deletion and rename\n        syncDiff(renameAndDeleteDiffs, targetFs, tmpDir);\n      }\n      return true;\n    } catch (Exception e) {\n      DistCp.LOG.warn(\"Failed to use snapshot diff for distcp\", e);\n      return false;\n    } finally {\n      deleteTargetTmpDir(targetFs, tmpDir);\n      // TODO: since we have tmp directory, we can support \"undo\" with failures\n      // set the source path using the snapshot path\n      inputOptions.setSourcePaths(Arrays.asList(getSourceSnapshotPath(sourceDir,\n          inputOptions.getToSnapshot())));\n    }\n  }",
          "path": "hadoop-tools/hadoop-distcp/src/main/java/org/apache/hadoop/tools/DistCpSync.java",
          "extendedDetails": {
            "oldValue": "[inputOptions-DistCpOptions, conf-Configuration]",
            "newValue": "[]"
          }
        },
        {
          "type": "Ymodifierchange",
          "commitMessage": "HDFS-8828. Utilize Snapshot diff report to build diff copy list in distcp. (Yufei Gu via Yongjun Zhang)\n",
          "commitDate": "20/08/15 8:02 AM",
          "commitName": "0bc15cb6e60dc60885234e01dec1c7cb4557a926",
          "commitAuthor": "Yongjun Zhang",
          "commitDateOld": "15/04/15 12:37 PM",
          "commitNameOld": "4c097e473bb1f18d1510deb61bae2bcb8c156f18",
          "commitAuthorOld": "Jing Zhao",
          "daysBetweenCommits": 126.81,
          "commitsBetweenForRepo": 958,
          "commitsBetweenForFile": 1,
          "diff": "@@ -1,52 +1,35 @@\n-  static boolean sync(DistCpOptions inputOptions, Configuration conf)\n-      throws IOException {\n-    List\u003cPath\u003e sourcePaths \u003d inputOptions.getSourcePaths();\n-    if (sourcePaths.size() !\u003d 1) {\n-      // we only support one source dir which must be a snapshottable directory\n-      throw new IllegalArgumentException(sourcePaths.size()\n-          + \" source paths are provided\");\n-    }\n-    final Path sourceDir \u003d sourcePaths.get(0);\n-    final Path targetDir \u003d inputOptions.getTargetPath();\n-\n-    final FileSystem sfs \u003d sourceDir.getFileSystem(conf);\n-    final FileSystem tfs \u003d targetDir.getFileSystem(conf);\n-    // currently we require both the source and the target file system are\n-    // DistributedFileSystem.\n-    if (!(sfs instanceof DistributedFileSystem) ||\n-        !(tfs instanceof DistributedFileSystem)) {\n-      throw new IllegalArgumentException(\"The FileSystems needs to\" +\n-          \" be DistributedFileSystem for using snapshot-diff-based distcp\");\n-    }\n-    final DistributedFileSystem sourceFs \u003d (DistributedFileSystem) sfs;\n-    final DistributedFileSystem targetFs\u003d (DistributedFileSystem) tfs;\n-\n-    // make sure targetFS has no change between from and the current states\n-    if (!checkNoChange(inputOptions, targetFs, targetDir)) {\n-      // set the source path using the snapshot path\n-      inputOptions.setSourcePaths(Arrays.asList(getSourceSnapshotPath(sourceDir,\n-          inputOptions.getToSnapshot())));\n+  public boolean sync() throws IOException {\n+    if (!preSyncCheck()) {\n       return false;\n     }\n \n+    if (!getAllDiffs()) {\n+      return false;\n+    }\n+\n+    List\u003cPath\u003e sourcePaths \u003d inputOptions.getSourcePaths();\n+    final Path sourceDir \u003d sourcePaths.get(0);\n+    final Path targetDir \u003d inputOptions.getTargetPath();\n+    final FileSystem tfs \u003d targetDir.getFileSystem(conf);\n+    final DistributedFileSystem targetFs \u003d (DistributedFileSystem) tfs;\n+\n     Path tmpDir \u003d null;\n     try {\n       tmpDir \u003d createTargetTmpDir(targetFs, targetDir);\n-      DiffInfo[] diffs \u003d getDiffs(inputOptions, sourceFs, sourceDir, targetDir);\n-      if (diffs \u003d\u003d null) {\n-        return false;\n+      DiffInfo[] renameAndDeleteDiffs \u003d getRenameAndDeleteDiffs(targetDir);\n+      if (renameAndDeleteDiffs.length \u003e 0) {\n+        // do the real sync work: deletion and rename\n+        syncDiff(renameAndDeleteDiffs, targetFs, tmpDir);\n       }\n-      // do the real sync work: deletion and rename\n-      syncDiff(diffs, targetFs, tmpDir);\n       return true;\n     } catch (Exception e) {\n       DistCp.LOG.warn(\"Failed to use snapshot diff for distcp\", e);\n       return false;\n     } finally {\n       deleteTargetTmpDir(targetFs, tmpDir);\n       // TODO: since we have tmp directory, we can support \"undo\" with failures\n       // set the source path using the snapshot path\n       inputOptions.setSourcePaths(Arrays.asList(getSourceSnapshotPath(sourceDir,\n           inputOptions.getToSnapshot())));\n     }\n   }\n\\ No newline at end of file\n",
          "actualSource": "  public boolean sync() throws IOException {\n    if (!preSyncCheck()) {\n      return false;\n    }\n\n    if (!getAllDiffs()) {\n      return false;\n    }\n\n    List\u003cPath\u003e sourcePaths \u003d inputOptions.getSourcePaths();\n    final Path sourceDir \u003d sourcePaths.get(0);\n    final Path targetDir \u003d inputOptions.getTargetPath();\n    final FileSystem tfs \u003d targetDir.getFileSystem(conf);\n    final DistributedFileSystem targetFs \u003d (DistributedFileSystem) tfs;\n\n    Path tmpDir \u003d null;\n    try {\n      tmpDir \u003d createTargetTmpDir(targetFs, targetDir);\n      DiffInfo[] renameAndDeleteDiffs \u003d getRenameAndDeleteDiffs(targetDir);\n      if (renameAndDeleteDiffs.length \u003e 0) {\n        // do the real sync work: deletion and rename\n        syncDiff(renameAndDeleteDiffs, targetFs, tmpDir);\n      }\n      return true;\n    } catch (Exception e) {\n      DistCp.LOG.warn(\"Failed to use snapshot diff for distcp\", e);\n      return false;\n    } finally {\n      deleteTargetTmpDir(targetFs, tmpDir);\n      // TODO: since we have tmp directory, we can support \"undo\" with failures\n      // set the source path using the snapshot path\n      inputOptions.setSourcePaths(Arrays.asList(getSourceSnapshotPath(sourceDir,\n          inputOptions.getToSnapshot())));\n    }\n  }",
          "path": "hadoop-tools/hadoop-distcp/src/main/java/org/apache/hadoop/tools/DistCpSync.java",
          "extendedDetails": {
            "oldValue": "[static]",
            "newValue": "[public]"
          }
        },
        {
          "type": "Ybodychange",
          "commitMessage": "HDFS-8828. Utilize Snapshot diff report to build diff copy list in distcp. (Yufei Gu via Yongjun Zhang)\n",
          "commitDate": "20/08/15 8:02 AM",
          "commitName": "0bc15cb6e60dc60885234e01dec1c7cb4557a926",
          "commitAuthor": "Yongjun Zhang",
          "commitDateOld": "15/04/15 12:37 PM",
          "commitNameOld": "4c097e473bb1f18d1510deb61bae2bcb8c156f18",
          "commitAuthorOld": "Jing Zhao",
          "daysBetweenCommits": 126.81,
          "commitsBetweenForRepo": 958,
          "commitsBetweenForFile": 1,
          "diff": "@@ -1,52 +1,35 @@\n-  static boolean sync(DistCpOptions inputOptions, Configuration conf)\n-      throws IOException {\n-    List\u003cPath\u003e sourcePaths \u003d inputOptions.getSourcePaths();\n-    if (sourcePaths.size() !\u003d 1) {\n-      // we only support one source dir which must be a snapshottable directory\n-      throw new IllegalArgumentException(sourcePaths.size()\n-          + \" source paths are provided\");\n-    }\n-    final Path sourceDir \u003d sourcePaths.get(0);\n-    final Path targetDir \u003d inputOptions.getTargetPath();\n-\n-    final FileSystem sfs \u003d sourceDir.getFileSystem(conf);\n-    final FileSystem tfs \u003d targetDir.getFileSystem(conf);\n-    // currently we require both the source and the target file system are\n-    // DistributedFileSystem.\n-    if (!(sfs instanceof DistributedFileSystem) ||\n-        !(tfs instanceof DistributedFileSystem)) {\n-      throw new IllegalArgumentException(\"The FileSystems needs to\" +\n-          \" be DistributedFileSystem for using snapshot-diff-based distcp\");\n-    }\n-    final DistributedFileSystem sourceFs \u003d (DistributedFileSystem) sfs;\n-    final DistributedFileSystem targetFs\u003d (DistributedFileSystem) tfs;\n-\n-    // make sure targetFS has no change between from and the current states\n-    if (!checkNoChange(inputOptions, targetFs, targetDir)) {\n-      // set the source path using the snapshot path\n-      inputOptions.setSourcePaths(Arrays.asList(getSourceSnapshotPath(sourceDir,\n-          inputOptions.getToSnapshot())));\n+  public boolean sync() throws IOException {\n+    if (!preSyncCheck()) {\n       return false;\n     }\n \n+    if (!getAllDiffs()) {\n+      return false;\n+    }\n+\n+    List\u003cPath\u003e sourcePaths \u003d inputOptions.getSourcePaths();\n+    final Path sourceDir \u003d sourcePaths.get(0);\n+    final Path targetDir \u003d inputOptions.getTargetPath();\n+    final FileSystem tfs \u003d targetDir.getFileSystem(conf);\n+    final DistributedFileSystem targetFs \u003d (DistributedFileSystem) tfs;\n+\n     Path tmpDir \u003d null;\n     try {\n       tmpDir \u003d createTargetTmpDir(targetFs, targetDir);\n-      DiffInfo[] diffs \u003d getDiffs(inputOptions, sourceFs, sourceDir, targetDir);\n-      if (diffs \u003d\u003d null) {\n-        return false;\n+      DiffInfo[] renameAndDeleteDiffs \u003d getRenameAndDeleteDiffs(targetDir);\n+      if (renameAndDeleteDiffs.length \u003e 0) {\n+        // do the real sync work: deletion and rename\n+        syncDiff(renameAndDeleteDiffs, targetFs, tmpDir);\n       }\n-      // do the real sync work: deletion and rename\n-      syncDiff(diffs, targetFs, tmpDir);\n       return true;\n     } catch (Exception e) {\n       DistCp.LOG.warn(\"Failed to use snapshot diff for distcp\", e);\n       return false;\n     } finally {\n       deleteTargetTmpDir(targetFs, tmpDir);\n       // TODO: since we have tmp directory, we can support \"undo\" with failures\n       // set the source path using the snapshot path\n       inputOptions.setSourcePaths(Arrays.asList(getSourceSnapshotPath(sourceDir,\n           inputOptions.getToSnapshot())));\n     }\n   }\n\\ No newline at end of file\n",
          "actualSource": "  public boolean sync() throws IOException {\n    if (!preSyncCheck()) {\n      return false;\n    }\n\n    if (!getAllDiffs()) {\n      return false;\n    }\n\n    List\u003cPath\u003e sourcePaths \u003d inputOptions.getSourcePaths();\n    final Path sourceDir \u003d sourcePaths.get(0);\n    final Path targetDir \u003d inputOptions.getTargetPath();\n    final FileSystem tfs \u003d targetDir.getFileSystem(conf);\n    final DistributedFileSystem targetFs \u003d (DistributedFileSystem) tfs;\n\n    Path tmpDir \u003d null;\n    try {\n      tmpDir \u003d createTargetTmpDir(targetFs, targetDir);\n      DiffInfo[] renameAndDeleteDiffs \u003d getRenameAndDeleteDiffs(targetDir);\n      if (renameAndDeleteDiffs.length \u003e 0) {\n        // do the real sync work: deletion and rename\n        syncDiff(renameAndDeleteDiffs, targetFs, tmpDir);\n      }\n      return true;\n    } catch (Exception e) {\n      DistCp.LOG.warn(\"Failed to use snapshot diff for distcp\", e);\n      return false;\n    } finally {\n      deleteTargetTmpDir(targetFs, tmpDir);\n      // TODO: since we have tmp directory, we can support \"undo\" with failures\n      // set the source path using the snapshot path\n      inputOptions.setSourcePaths(Arrays.asList(getSourceSnapshotPath(sourceDir,\n          inputOptions.getToSnapshot())));\n    }\n  }",
          "path": "hadoop-tools/hadoop-distcp/src/main/java/org/apache/hadoop/tools/DistCpSync.java",
          "extendedDetails": {}
        }
      ]
    },
    "4c097e473bb1f18d1510deb61bae2bcb8c156f18": {
      "type": "Ybodychange",
      "commitMessage": "HDFS-8151. Always use snapshot path as source when invalid snapshot names are used for diff based distcp. Contributed by Jing Zhao.\n",
      "commitDate": "15/04/15 12:37 PM",
      "commitName": "4c097e473bb1f18d1510deb61bae2bcb8c156f18",
      "commitAuthor": "Jing Zhao",
      "commitDateOld": "01/04/15 4:50 PM",
      "commitNameOld": "75cb1d42abec54ef5484636e020949ceebe189e9",
      "commitAuthorOld": "Haohui Mai",
      "daysBetweenCommits": 13.82,
      "commitsBetweenForRepo": 112,
      "commitsBetweenForFile": 1,
      "diff": "@@ -1,50 +1,52 @@\n   static boolean sync(DistCpOptions inputOptions, Configuration conf)\n       throws IOException {\n     List\u003cPath\u003e sourcePaths \u003d inputOptions.getSourcePaths();\n     if (sourcePaths.size() !\u003d 1) {\n       // we only support one source dir which must be a snapshottable directory\n-      DistCp.LOG.warn(sourcePaths.size() + \" source paths are provided\");\n-      return false;\n+      throw new IllegalArgumentException(sourcePaths.size()\n+          + \" source paths are provided\");\n     }\n     final Path sourceDir \u003d sourcePaths.get(0);\n     final Path targetDir \u003d inputOptions.getTargetPath();\n \n     final FileSystem sfs \u003d sourceDir.getFileSystem(conf);\n     final FileSystem tfs \u003d targetDir.getFileSystem(conf);\n     // currently we require both the source and the target file system are\n     // DistributedFileSystem.\n     if (!(sfs instanceof DistributedFileSystem) ||\n         !(tfs instanceof DistributedFileSystem)) {\n-      DistCp.LOG.warn(\"To use diff-based distcp, the FileSystems needs to\" +\n-          \" be DistributedFileSystem\");\n-      return false;\n+      throw new IllegalArgumentException(\"The FileSystems needs to\" +\n+          \" be DistributedFileSystem for using snapshot-diff-based distcp\");\n     }\n     final DistributedFileSystem sourceFs \u003d (DistributedFileSystem) sfs;\n     final DistributedFileSystem targetFs\u003d (DistributedFileSystem) tfs;\n \n     // make sure targetFS has no change between from and the current states\n     if (!checkNoChange(inputOptions, targetFs, targetDir)) {\n+      // set the source path using the snapshot path\n+      inputOptions.setSourcePaths(Arrays.asList(getSourceSnapshotPath(sourceDir,\n+          inputOptions.getToSnapshot())));\n       return false;\n     }\n \n     Path tmpDir \u003d null;\n     try {\n       tmpDir \u003d createTargetTmpDir(targetFs, targetDir);\n       DiffInfo[] diffs \u003d getDiffs(inputOptions, sourceFs, sourceDir, targetDir);\n       if (diffs \u003d\u003d null) {\n         return false;\n       }\n       // do the real sync work: deletion and rename\n       syncDiff(diffs, targetFs, tmpDir);\n       return true;\n     } catch (Exception e) {\n       DistCp.LOG.warn(\"Failed to use snapshot diff for distcp\", e);\n       return false;\n     } finally {\n       deleteTargetTmpDir(targetFs, tmpDir);\n       // TODO: since we have tmp directory, we can support \"undo\" with failures\n       // set the source path using the snapshot path\n       inputOptions.setSourcePaths(Arrays.asList(getSourceSnapshotPath(sourceDir,\n           inputOptions.getToSnapshot())));\n     }\n   }\n\\ No newline at end of file\n",
      "actualSource": "  static boolean sync(DistCpOptions inputOptions, Configuration conf)\n      throws IOException {\n    List\u003cPath\u003e sourcePaths \u003d inputOptions.getSourcePaths();\n    if (sourcePaths.size() !\u003d 1) {\n      // we only support one source dir which must be a snapshottable directory\n      throw new IllegalArgumentException(sourcePaths.size()\n          + \" source paths are provided\");\n    }\n    final Path sourceDir \u003d sourcePaths.get(0);\n    final Path targetDir \u003d inputOptions.getTargetPath();\n\n    final FileSystem sfs \u003d sourceDir.getFileSystem(conf);\n    final FileSystem tfs \u003d targetDir.getFileSystem(conf);\n    // currently we require both the source and the target file system are\n    // DistributedFileSystem.\n    if (!(sfs instanceof DistributedFileSystem) ||\n        !(tfs instanceof DistributedFileSystem)) {\n      throw new IllegalArgumentException(\"The FileSystems needs to\" +\n          \" be DistributedFileSystem for using snapshot-diff-based distcp\");\n    }\n    final DistributedFileSystem sourceFs \u003d (DistributedFileSystem) sfs;\n    final DistributedFileSystem targetFs\u003d (DistributedFileSystem) tfs;\n\n    // make sure targetFS has no change between from and the current states\n    if (!checkNoChange(inputOptions, targetFs, targetDir)) {\n      // set the source path using the snapshot path\n      inputOptions.setSourcePaths(Arrays.asList(getSourceSnapshotPath(sourceDir,\n          inputOptions.getToSnapshot())));\n      return false;\n    }\n\n    Path tmpDir \u003d null;\n    try {\n      tmpDir \u003d createTargetTmpDir(targetFs, targetDir);\n      DiffInfo[] diffs \u003d getDiffs(inputOptions, sourceFs, sourceDir, targetDir);\n      if (diffs \u003d\u003d null) {\n        return false;\n      }\n      // do the real sync work: deletion and rename\n      syncDiff(diffs, targetFs, tmpDir);\n      return true;\n    } catch (Exception e) {\n      DistCp.LOG.warn(\"Failed to use snapshot diff for distcp\", e);\n      return false;\n    } finally {\n      deleteTargetTmpDir(targetFs, tmpDir);\n      // TODO: since we have tmp directory, we can support \"undo\" with failures\n      // set the source path using the snapshot path\n      inputOptions.setSourcePaths(Arrays.asList(getSourceSnapshotPath(sourceDir,\n          inputOptions.getToSnapshot())));\n    }\n  }",
      "path": "hadoop-tools/hadoop-distcp/src/main/java/org/apache/hadoop/tools/DistCpSync.java",
      "extendedDetails": {}
    },
    "75cb1d42abec54ef5484636e020949ceebe189e9": {
      "type": "Ybodychange",
      "commitMessage": "HDFS-8036. Use snapshot path as source when using snapshot diff report in DistCp. Contributed by Jing Zhao.\n",
      "commitDate": "01/04/15 4:50 PM",
      "commitName": "75cb1d42abec54ef5484636e020949ceebe189e9",
      "commitAuthor": "Haohui Mai",
      "commitDateOld": "04/03/15 10:30 AM",
      "commitNameOld": "ed70fa142cabdbc1065e4dbbc95e99c8850c4751",
      "commitAuthorOld": "Jing Zhao",
      "daysBetweenCommits": 28.22,
      "commitsBetweenForRepo": 255,
      "commitsBetweenForFile": 1,
      "diff": "@@ -1,47 +1,50 @@\n   static boolean sync(DistCpOptions inputOptions, Configuration conf)\n       throws IOException {\n     List\u003cPath\u003e sourcePaths \u003d inputOptions.getSourcePaths();\n     if (sourcePaths.size() !\u003d 1) {\n       // we only support one source dir which must be a snapshottable directory\n       DistCp.LOG.warn(sourcePaths.size() + \" source paths are provided\");\n       return false;\n     }\n     final Path sourceDir \u003d sourcePaths.get(0);\n     final Path targetDir \u003d inputOptions.getTargetPath();\n \n     final FileSystem sfs \u003d sourceDir.getFileSystem(conf);\n     final FileSystem tfs \u003d targetDir.getFileSystem(conf);\n     // currently we require both the source and the target file system are\n     // DistributedFileSystem.\n     if (!(sfs instanceof DistributedFileSystem) ||\n         !(tfs instanceof DistributedFileSystem)) {\n       DistCp.LOG.warn(\"To use diff-based distcp, the FileSystems needs to\" +\n           \" be DistributedFileSystem\");\n       return false;\n     }\n     final DistributedFileSystem sourceFs \u003d (DistributedFileSystem) sfs;\n     final DistributedFileSystem targetFs\u003d (DistributedFileSystem) tfs;\n \n     // make sure targetFS has no change between from and the current states\n     if (!checkNoChange(inputOptions, targetFs, targetDir)) {\n       return false;\n     }\n \n     Path tmpDir \u003d null;\n     try {\n       tmpDir \u003d createTargetTmpDir(targetFs, targetDir);\n       DiffInfo[] diffs \u003d getDiffs(inputOptions, sourceFs, sourceDir, targetDir);\n       if (diffs \u003d\u003d null) {\n         return false;\n       }\n       // do the real sync work: deletion and rename\n       syncDiff(diffs, targetFs, tmpDir);\n       return true;\n     } catch (Exception e) {\n       DistCp.LOG.warn(\"Failed to use snapshot diff for distcp\", e);\n       return false;\n     } finally {\n       deleteTargetTmpDir(targetFs, tmpDir);\n       // TODO: since we have tmp directory, we can support \"undo\" with failures\n+      // set the source path using the snapshot path\n+      inputOptions.setSourcePaths(Arrays.asList(getSourceSnapshotPath(sourceDir,\n+          inputOptions.getToSnapshot())));\n     }\n   }\n\\ No newline at end of file\n",
      "actualSource": "  static boolean sync(DistCpOptions inputOptions, Configuration conf)\n      throws IOException {\n    List\u003cPath\u003e sourcePaths \u003d inputOptions.getSourcePaths();\n    if (sourcePaths.size() !\u003d 1) {\n      // we only support one source dir which must be a snapshottable directory\n      DistCp.LOG.warn(sourcePaths.size() + \" source paths are provided\");\n      return false;\n    }\n    final Path sourceDir \u003d sourcePaths.get(0);\n    final Path targetDir \u003d inputOptions.getTargetPath();\n\n    final FileSystem sfs \u003d sourceDir.getFileSystem(conf);\n    final FileSystem tfs \u003d targetDir.getFileSystem(conf);\n    // currently we require both the source and the target file system are\n    // DistributedFileSystem.\n    if (!(sfs instanceof DistributedFileSystem) ||\n        !(tfs instanceof DistributedFileSystem)) {\n      DistCp.LOG.warn(\"To use diff-based distcp, the FileSystems needs to\" +\n          \" be DistributedFileSystem\");\n      return false;\n    }\n    final DistributedFileSystem sourceFs \u003d (DistributedFileSystem) sfs;\n    final DistributedFileSystem targetFs\u003d (DistributedFileSystem) tfs;\n\n    // make sure targetFS has no change between from and the current states\n    if (!checkNoChange(inputOptions, targetFs, targetDir)) {\n      return false;\n    }\n\n    Path tmpDir \u003d null;\n    try {\n      tmpDir \u003d createTargetTmpDir(targetFs, targetDir);\n      DiffInfo[] diffs \u003d getDiffs(inputOptions, sourceFs, sourceDir, targetDir);\n      if (diffs \u003d\u003d null) {\n        return false;\n      }\n      // do the real sync work: deletion and rename\n      syncDiff(diffs, targetFs, tmpDir);\n      return true;\n    } catch (Exception e) {\n      DistCp.LOG.warn(\"Failed to use snapshot diff for distcp\", e);\n      return false;\n    } finally {\n      deleteTargetTmpDir(targetFs, tmpDir);\n      // TODO: since we have tmp directory, we can support \"undo\" with failures\n      // set the source path using the snapshot path\n      inputOptions.setSourcePaths(Arrays.asList(getSourceSnapshotPath(sourceDir,\n          inputOptions.getToSnapshot())));\n    }\n  }",
      "path": "hadoop-tools/hadoop-distcp/src/main/java/org/apache/hadoop/tools/DistCpSync.java",
      "extendedDetails": {}
    },
    "ed70fa142cabdbc1065e4dbbc95e99c8850c4751": {
      "type": "Yintroduced",
      "commitMessage": "HDFS-7535. Utilize Snapshot diff report for distcp. Contributed by Jing Zhao.\n",
      "commitDate": "04/03/15 10:30 AM",
      "commitName": "ed70fa142cabdbc1065e4dbbc95e99c8850c4751",
      "commitAuthor": "Jing Zhao",
      "diff": "@@ -0,0 +1,47 @@\n+  static boolean sync(DistCpOptions inputOptions, Configuration conf)\n+      throws IOException {\n+    List\u003cPath\u003e sourcePaths \u003d inputOptions.getSourcePaths();\n+    if (sourcePaths.size() !\u003d 1) {\n+      // we only support one source dir which must be a snapshottable directory\n+      DistCp.LOG.warn(sourcePaths.size() + \" source paths are provided\");\n+      return false;\n+    }\n+    final Path sourceDir \u003d sourcePaths.get(0);\n+    final Path targetDir \u003d inputOptions.getTargetPath();\n+\n+    final FileSystem sfs \u003d sourceDir.getFileSystem(conf);\n+    final FileSystem tfs \u003d targetDir.getFileSystem(conf);\n+    // currently we require both the source and the target file system are\n+    // DistributedFileSystem.\n+    if (!(sfs instanceof DistributedFileSystem) ||\n+        !(tfs instanceof DistributedFileSystem)) {\n+      DistCp.LOG.warn(\"To use diff-based distcp, the FileSystems needs to\" +\n+          \" be DistributedFileSystem\");\n+      return false;\n+    }\n+    final DistributedFileSystem sourceFs \u003d (DistributedFileSystem) sfs;\n+    final DistributedFileSystem targetFs\u003d (DistributedFileSystem) tfs;\n+\n+    // make sure targetFS has no change between from and the current states\n+    if (!checkNoChange(inputOptions, targetFs, targetDir)) {\n+      return false;\n+    }\n+\n+    Path tmpDir \u003d null;\n+    try {\n+      tmpDir \u003d createTargetTmpDir(targetFs, targetDir);\n+      DiffInfo[] diffs \u003d getDiffs(inputOptions, sourceFs, sourceDir, targetDir);\n+      if (diffs \u003d\u003d null) {\n+        return false;\n+      }\n+      // do the real sync work: deletion and rename\n+      syncDiff(diffs, targetFs, tmpDir);\n+      return true;\n+    } catch (Exception e) {\n+      DistCp.LOG.warn(\"Failed to use snapshot diff for distcp\", e);\n+      return false;\n+    } finally {\n+      deleteTargetTmpDir(targetFs, tmpDir);\n+      // TODO: since we have tmp directory, we can support \"undo\" with failures\n+    }\n+  }\n\\ No newline at end of file\n",
      "actualSource": "  static boolean sync(DistCpOptions inputOptions, Configuration conf)\n      throws IOException {\n    List\u003cPath\u003e sourcePaths \u003d inputOptions.getSourcePaths();\n    if (sourcePaths.size() !\u003d 1) {\n      // we only support one source dir which must be a snapshottable directory\n      DistCp.LOG.warn(sourcePaths.size() + \" source paths are provided\");\n      return false;\n    }\n    final Path sourceDir \u003d sourcePaths.get(0);\n    final Path targetDir \u003d inputOptions.getTargetPath();\n\n    final FileSystem sfs \u003d sourceDir.getFileSystem(conf);\n    final FileSystem tfs \u003d targetDir.getFileSystem(conf);\n    // currently we require both the source and the target file system are\n    // DistributedFileSystem.\n    if (!(sfs instanceof DistributedFileSystem) ||\n        !(tfs instanceof DistributedFileSystem)) {\n      DistCp.LOG.warn(\"To use diff-based distcp, the FileSystems needs to\" +\n          \" be DistributedFileSystem\");\n      return false;\n    }\n    final DistributedFileSystem sourceFs \u003d (DistributedFileSystem) sfs;\n    final DistributedFileSystem targetFs\u003d (DistributedFileSystem) tfs;\n\n    // make sure targetFS has no change between from and the current states\n    if (!checkNoChange(inputOptions, targetFs, targetDir)) {\n      return false;\n    }\n\n    Path tmpDir \u003d null;\n    try {\n      tmpDir \u003d createTargetTmpDir(targetFs, targetDir);\n      DiffInfo[] diffs \u003d getDiffs(inputOptions, sourceFs, sourceDir, targetDir);\n      if (diffs \u003d\u003d null) {\n        return false;\n      }\n      // do the real sync work: deletion and rename\n      syncDiff(diffs, targetFs, tmpDir);\n      return true;\n    } catch (Exception e) {\n      DistCp.LOG.warn(\"Failed to use snapshot diff for distcp\", e);\n      return false;\n    } finally {\n      deleteTargetTmpDir(targetFs, tmpDir);\n      // TODO: since we have tmp directory, we can support \"undo\" with failures\n    }\n  }",
      "path": "hadoop-tools/hadoop-distcp/src/main/java/org/apache/hadoop/tools/DistCpSync.java"
    }
  }
}