{
  "origin": "codeshovel",
  "repositoryName": "hadoop",
  "repositoryPath": "/home/shaiful/research/codeshovel/codeshovel-projects/hadoop/.git",
  "startCommitName": "HEAD",
  "sourceFileName": "S3AFileSystem.java",
  "functionName": "deleteUnnecessaryFakeDirectories",
  "functionId": "deleteUnnecessaryFakeDirectories___path-Path",
  "sourceFilePath": "hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/S3AFileSystem.java",
  "functionStartLine": 3727,
  "functionEndLine": 3748,
  "numCommitsSeen": 185,
  "timeTaken": 7276,
  "changeHistory": [
    "511df1e837b19ccb9271520589452d82d50ac69d",
    "e02eb24e0a9139418120027b694492e0738df20a",
    "de8b6ca5ef8614de6d6277b7617e27c788b0555c",
    "6aeda55bb8f741d9dafd41f6dfbf1a88acdd4003",
    "ebd4f39a393e5fa9a810c6a36b749549229a53df",
    "ee0c722dc8fb81ec902cd1da5958ce5adb0ab08f",
    "c58a59f7081d55dd2108545ebf9ee48cf43ca944",
    "39ec1515a205952eda7e171408a8b83eceb4abde",
    "27c4e90efce04e1b1302f668b5eb22412e00d033",
    "709ff99cff4124823bde631e272af7be9a22f83b",
    "24d920b80eb3626073925a1d0b6dcf148add8cc0"
  ],
  "changeHistoryShort": {
    "511df1e837b19ccb9271520589452d82d50ac69d": "Ybodychange",
    "e02eb24e0a9139418120027b694492e0738df20a": "Ybodychange",
    "de8b6ca5ef8614de6d6277b7617e27c788b0555c": "Ybodychange",
    "6aeda55bb8f741d9dafd41f6dfbf1a88acdd4003": "Ybodychange",
    "ebd4f39a393e5fa9a810c6a36b749549229a53df": "Ybodychange",
    "ee0c722dc8fb81ec902cd1da5958ce5adb0ab08f": "Ymultichange(Yparameterchange,Ybodychange)",
    "c58a59f7081d55dd2108545ebf9ee48cf43ca944": "Ybodychange",
    "39ec1515a205952eda7e171408a8b83eceb4abde": "Ymultichange(Yexceptionschange,Ybodychange)",
    "27c4e90efce04e1b1302f668b5eb22412e00d033": "Ybodychange",
    "709ff99cff4124823bde631e272af7be9a22f83b": "Ybodychange",
    "24d920b80eb3626073925a1d0b6dcf148add8cc0": "Yintroduced"
  },
  "changeHistoryDetails": {
    "511df1e837b19ccb9271520589452d82d50ac69d": {
      "type": "Ybodychange",
      "commitMessage": "HADOOP-16430. S3AFilesystem.delete to incrementally update s3guard with deletions\n\nContributed by Steve Loughran.\n\nThis overlaps the scanning for directory entries with batched calls to S3 DELETE and updates of the S3Guard tables.\nIt also uses S3Guard to list the files to delete, so find newly created files even when S3 listings are not use consistent.\n\nFor path which the client considers S3Guard to be authoritative, we also do a recursive LIST of the store and delete files; this is to find unindexed files and do guarantee that the delete(path, true) call really does delete everything underneath.\n\nChange-Id: Ice2f6e940c506e0b3a78fa534a99721b1698708e\n",
      "commitDate": "05/09/19 6:25 AM",
      "commitName": "511df1e837b19ccb9271520589452d82d50ac69d",
      "commitAuthor": "Steve Loughran",
      "commitDateOld": "23/07/19 6:52 AM",
      "commitNameOld": "4317d332321778269a583e2223d433107fab82eb",
      "commitAuthorOld": "Steve Loughran",
      "daysBetweenCommits": 43.98,
      "commitsBetweenForRepo": 415,
      "commitsBetweenForFile": 1,
      "diff": "@@ -1,22 +1,22 @@\n   private void deleteUnnecessaryFakeDirectories(Path path) {\n     List\u003cDeleteObjectsRequest.KeyVersion\u003e keysToRemove \u003d new ArrayList\u003c\u003e();\n     while (!path.isRoot()) {\n       String key \u003d pathToKey(path);\n       key \u003d (key.endsWith(\"/\")) ? key : (key + \"/\");\n       LOG.trace(\"To delete unnecessary fake directory {} for {}\", key, path);\n       keysToRemove.add(new DeleteObjectsRequest.KeyVersion(key));\n       path \u003d path.getParent();\n     }\n     try {\n-      removeKeys(keysToRemove, true);\n+      removeKeys(keysToRemove, true, null);\n     } catch(AmazonClientException | IOException e) {\n       instrumentation.errorIgnored();\n       if (LOG.isDebugEnabled()) {\n         StringBuilder sb \u003d new StringBuilder();\n         for(DeleteObjectsRequest.KeyVersion kv : keysToRemove) {\n           sb.append(kv.getKey()).append(\",\");\n         }\n         LOG.debug(\"While deleting keys {} \", sb.toString(), e);\n       }\n     }\n   }\n\\ No newline at end of file\n",
      "actualSource": "  private void deleteUnnecessaryFakeDirectories(Path path) {\n    List\u003cDeleteObjectsRequest.KeyVersion\u003e keysToRemove \u003d new ArrayList\u003c\u003e();\n    while (!path.isRoot()) {\n      String key \u003d pathToKey(path);\n      key \u003d (key.endsWith(\"/\")) ? key : (key + \"/\");\n      LOG.trace(\"To delete unnecessary fake directory {} for {}\", key, path);\n      keysToRemove.add(new DeleteObjectsRequest.KeyVersion(key));\n      path \u003d path.getParent();\n    }\n    try {\n      removeKeys(keysToRemove, true, null);\n    } catch(AmazonClientException | IOException e) {\n      instrumentation.errorIgnored();\n      if (LOG.isDebugEnabled()) {\n        StringBuilder sb \u003d new StringBuilder();\n        for(DeleteObjectsRequest.KeyVersion kv : keysToRemove) {\n          sb.append(kv.getKey()).append(\",\");\n        }\n        LOG.debug(\"While deleting keys {} \", sb.toString(), e);\n      }\n    }\n  }",
      "path": "hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/S3AFileSystem.java",
      "extendedDetails": {}
    },
    "e02eb24e0a9139418120027b694492e0738df20a": {
      "type": "Ybodychange",
      "commitMessage": "HADOOP-15183. S3Guard store becomes inconsistent after partial failure of rename.\n\nContributed by Steve Loughran.\n\nChange-Id: I825b0bc36be960475d2d259b1cdab45ae1bb78eb\n",
      "commitDate": "20/06/19 1:56 AM",
      "commitName": "e02eb24e0a9139418120027b694492e0738df20a",
      "commitAuthor": "Steve Loughran",
      "commitDateOld": "16/06/19 9:05 AM",
      "commitNameOld": "f9cc9e162175444efe9d5b07ecb9a795f750ca3c",
      "commitAuthorOld": "Gabor Bota",
      "daysBetweenCommits": 3.7,
      "commitsBetweenForRepo": 44,
      "commitsBetweenForFile": 1,
      "diff": "@@ -1,22 +1,22 @@\n   private void deleteUnnecessaryFakeDirectories(Path path) {\n     List\u003cDeleteObjectsRequest.KeyVersion\u003e keysToRemove \u003d new ArrayList\u003c\u003e();\n     while (!path.isRoot()) {\n       String key \u003d pathToKey(path);\n       key \u003d (key.endsWith(\"/\")) ? key : (key + \"/\");\n       LOG.trace(\"To delete unnecessary fake directory {} for {}\", key, path);\n       keysToRemove.add(new DeleteObjectsRequest.KeyVersion(key));\n       path \u003d path.getParent();\n     }\n     try {\n-      removeKeys(keysToRemove, false, true);\n+      removeKeys(keysToRemove, true);\n     } catch(AmazonClientException | IOException e) {\n       instrumentation.errorIgnored();\n       if (LOG.isDebugEnabled()) {\n         StringBuilder sb \u003d new StringBuilder();\n         for(DeleteObjectsRequest.KeyVersion kv : keysToRemove) {\n           sb.append(kv.getKey()).append(\",\");\n         }\n         LOG.debug(\"While deleting keys {} \", sb.toString(), e);\n       }\n     }\n   }\n\\ No newline at end of file\n",
      "actualSource": "  private void deleteUnnecessaryFakeDirectories(Path path) {\n    List\u003cDeleteObjectsRequest.KeyVersion\u003e keysToRemove \u003d new ArrayList\u003c\u003e();\n    while (!path.isRoot()) {\n      String key \u003d pathToKey(path);\n      key \u003d (key.endsWith(\"/\")) ? key : (key + \"/\");\n      LOG.trace(\"To delete unnecessary fake directory {} for {}\", key, path);\n      keysToRemove.add(new DeleteObjectsRequest.KeyVersion(key));\n      path \u003d path.getParent();\n    }\n    try {\n      removeKeys(keysToRemove, true);\n    } catch(AmazonClientException | IOException e) {\n      instrumentation.errorIgnored();\n      if (LOG.isDebugEnabled()) {\n        StringBuilder sb \u003d new StringBuilder();\n        for(DeleteObjectsRequest.KeyVersion kv : keysToRemove) {\n          sb.append(kv.getKey()).append(\",\");\n        }\n        LOG.debug(\"While deleting keys {} \", sb.toString(), e);\n      }\n    }\n  }",
      "path": "hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/S3AFileSystem.java",
      "extendedDetails": {}
    },
    "de8b6ca5ef8614de6d6277b7617e27c788b0555c": {
      "type": "Ybodychange",
      "commitMessage": "HADOOP-13786 Add S3A committer for zero-rename commits to S3 endpoints.\nContributed by Steve Loughran and Ryan Blue.\n",
      "commitDate": "22/11/17 7:28 AM",
      "commitName": "de8b6ca5ef8614de6d6277b7617e27c788b0555c",
      "commitAuthor": "Steve Loughran",
      "commitDateOld": "25/09/17 3:59 PM",
      "commitNameOld": "47011d7dd300b0c74bb6cfe25b918c479d718f4f",
      "commitAuthorOld": "Aaron Fabbri",
      "daysBetweenCommits": 57.69,
      "commitsBetweenForRepo": 477,
      "commitsBetweenForFile": 1,
      "diff": "@@ -1,22 +1,22 @@\n   private void deleteUnnecessaryFakeDirectories(Path path) {\n     List\u003cDeleteObjectsRequest.KeyVersion\u003e keysToRemove \u003d new ArrayList\u003c\u003e();\n     while (!path.isRoot()) {\n       String key \u003d pathToKey(path);\n       key \u003d (key.endsWith(\"/\")) ? key : (key + \"/\");\n       LOG.trace(\"To delete unnecessary fake directory {} for {}\", key, path);\n       keysToRemove.add(new DeleteObjectsRequest.KeyVersion(key));\n       path \u003d path.getParent();\n     }\n     try {\n       removeKeys(keysToRemove, false, true);\n-    } catch(AmazonClientException | InvalidRequestException e) {\n+    } catch(AmazonClientException | IOException e) {\n       instrumentation.errorIgnored();\n       if (LOG.isDebugEnabled()) {\n         StringBuilder sb \u003d new StringBuilder();\n         for(DeleteObjectsRequest.KeyVersion kv : keysToRemove) {\n           sb.append(kv.getKey()).append(\",\");\n         }\n         LOG.debug(\"While deleting keys {} \", sb.toString(), e);\n       }\n     }\n   }\n\\ No newline at end of file\n",
      "actualSource": "  private void deleteUnnecessaryFakeDirectories(Path path) {\n    List\u003cDeleteObjectsRequest.KeyVersion\u003e keysToRemove \u003d new ArrayList\u003c\u003e();\n    while (!path.isRoot()) {\n      String key \u003d pathToKey(path);\n      key \u003d (key.endsWith(\"/\")) ? key : (key + \"/\");\n      LOG.trace(\"To delete unnecessary fake directory {} for {}\", key, path);\n      keysToRemove.add(new DeleteObjectsRequest.KeyVersion(key));\n      path \u003d path.getParent();\n    }\n    try {\n      removeKeys(keysToRemove, false, true);\n    } catch(AmazonClientException | IOException e) {\n      instrumentation.errorIgnored();\n      if (LOG.isDebugEnabled()) {\n        StringBuilder sb \u003d new StringBuilder();\n        for(DeleteObjectsRequest.KeyVersion kv : keysToRemove) {\n          sb.append(kv.getKey()).append(\",\");\n        }\n        LOG.debug(\"While deleting keys {} \", sb.toString(), e);\n      }\n    }\n  }",
      "path": "hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/S3AFileSystem.java",
      "extendedDetails": {}
    },
    "6aeda55bb8f741d9dafd41f6dfbf1a88acdd4003": {
      "type": "Ybodychange",
      "commitMessage": "HADOOP-14428. s3a: mkdir appears to be broken. Contributed by Mingliang Liu\n",
      "commitDate": "05/06/17 11:26 AM",
      "commitName": "6aeda55bb8f741d9dafd41f6dfbf1a88acdd4003",
      "commitAuthor": "Mingliang Liu",
      "commitDateOld": "19/05/17 11:51 AM",
      "commitNameOld": "6672810eeac1c94fd764aaf2a709ace9d4b5aa76",
      "commitAuthorOld": "Mingliang Liu",
      "daysBetweenCommits": 16.98,
      "commitsBetweenForRepo": 78,
      "commitsBetweenForFile": 1,
      "diff": "@@ -1,21 +1,22 @@\n   private void deleteUnnecessaryFakeDirectories(Path path) {\n     List\u003cDeleteObjectsRequest.KeyVersion\u003e keysToRemove \u003d new ArrayList\u003c\u003e();\n     while (!path.isRoot()) {\n       String key \u003d pathToKey(path);\n       key \u003d (key.endsWith(\"/\")) ? key : (key + \"/\");\n+      LOG.trace(\"To delete unnecessary fake directory {} for {}\", key, path);\n       keysToRemove.add(new DeleteObjectsRequest.KeyVersion(key));\n       path \u003d path.getParent();\n     }\n     try {\n       removeKeys(keysToRemove, false, true);\n     } catch(AmazonClientException | InvalidRequestException e) {\n       instrumentation.errorIgnored();\n       if (LOG.isDebugEnabled()) {\n         StringBuilder sb \u003d new StringBuilder();\n         for(DeleteObjectsRequest.KeyVersion kv : keysToRemove) {\n           sb.append(kv.getKey()).append(\",\");\n         }\n         LOG.debug(\"While deleting keys {} \", sb.toString(), e);\n       }\n     }\n   }\n\\ No newline at end of file\n",
      "actualSource": "  private void deleteUnnecessaryFakeDirectories(Path path) {\n    List\u003cDeleteObjectsRequest.KeyVersion\u003e keysToRemove \u003d new ArrayList\u003c\u003e();\n    while (!path.isRoot()) {\n      String key \u003d pathToKey(path);\n      key \u003d (key.endsWith(\"/\")) ? key : (key + \"/\");\n      LOG.trace(\"To delete unnecessary fake directory {} for {}\", key, path);\n      keysToRemove.add(new DeleteObjectsRequest.KeyVersion(key));\n      path \u003d path.getParent();\n    }\n    try {\n      removeKeys(keysToRemove, false, true);\n    } catch(AmazonClientException | InvalidRequestException e) {\n      instrumentation.errorIgnored();\n      if (LOG.isDebugEnabled()) {\n        StringBuilder sb \u003d new StringBuilder();\n        for(DeleteObjectsRequest.KeyVersion kv : keysToRemove) {\n          sb.append(kv.getKey()).append(\",\");\n        }\n        LOG.debug(\"While deleting keys {} \", sb.toString(), e);\n      }\n    }\n  }",
      "path": "hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/S3AFileSystem.java",
      "extendedDetails": {}
    },
    "ebd4f39a393e5fa9a810c6a36b749549229a53df": {
      "type": "Ybodychange",
      "commitMessage": "HADOOP-12977 s3a to handle delete(\"/\", true) robustly. Contributed by Steve Loughran.\n",
      "commitDate": "07/10/16 4:51 AM",
      "commitName": "ebd4f39a393e5fa9a810c6a36b749549229a53df",
      "commitAuthor": "Steve Loughran",
      "commitDateOld": "05/10/16 7:02 AM",
      "commitNameOld": "d6be1e75d8e5b846f463e79bfbce889d31b943a7",
      "commitAuthorOld": "Steve Loughran",
      "daysBetweenCommits": 1.91,
      "commitsBetweenForRepo": 19,
      "commitsBetweenForFile": 1,
      "diff": "@@ -1,21 +1,21 @@\n   private void deleteUnnecessaryFakeDirectories(Path path) {\n     List\u003cDeleteObjectsRequest.KeyVersion\u003e keysToRemove \u003d new ArrayList\u003c\u003e();\n     while (!path.isRoot()) {\n       String key \u003d pathToKey(path);\n       key \u003d (key.endsWith(\"/\")) ? key : (key + \"/\");\n       keysToRemove.add(new DeleteObjectsRequest.KeyVersion(key));\n       path \u003d path.getParent();\n     }\n     try {\n       removeKeys(keysToRemove, false, true);\n-    } catch(AmazonClientException e) {\n+    } catch(AmazonClientException | InvalidRequestException e) {\n       instrumentation.errorIgnored();\n       if (LOG.isDebugEnabled()) {\n         StringBuilder sb \u003d new StringBuilder();\n         for(DeleteObjectsRequest.KeyVersion kv : keysToRemove) {\n           sb.append(kv.getKey()).append(\",\");\n         }\n         LOG.debug(\"While deleting keys {} \", sb.toString(), e);\n       }\n     }\n   }\n\\ No newline at end of file\n",
      "actualSource": "  private void deleteUnnecessaryFakeDirectories(Path path) {\n    List\u003cDeleteObjectsRequest.KeyVersion\u003e keysToRemove \u003d new ArrayList\u003c\u003e();\n    while (!path.isRoot()) {\n      String key \u003d pathToKey(path);\n      key \u003d (key.endsWith(\"/\")) ? key : (key + \"/\");\n      keysToRemove.add(new DeleteObjectsRequest.KeyVersion(key));\n      path \u003d path.getParent();\n    }\n    try {\n      removeKeys(keysToRemove, false, true);\n    } catch(AmazonClientException | InvalidRequestException e) {\n      instrumentation.errorIgnored();\n      if (LOG.isDebugEnabled()) {\n        StringBuilder sb \u003d new StringBuilder();\n        for(DeleteObjectsRequest.KeyVersion kv : keysToRemove) {\n          sb.append(kv.getKey()).append(\",\");\n        }\n        LOG.debug(\"While deleting keys {} \", sb.toString(), e);\n      }\n    }\n  }",
      "path": "hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/S3AFileSystem.java",
      "extendedDetails": {}
    },
    "ee0c722dc8fb81ec902cd1da5958ce5adb0ab08f": {
      "type": "Ymultichange(Yparameterchange,Ybodychange)",
      "commitMessage": "HADOOP-13164 Optimize S3AFileSystem::deleteUnnecessaryFakeDirectories. Contributed by Rajesh Balamohan.\n",
      "commitDate": "29/09/16 9:01 AM",
      "commitName": "ee0c722dc8fb81ec902cd1da5958ce5adb0ab08f",
      "commitAuthor": "Steve Loughran",
      "subchanges": [
        {
          "type": "Yparameterchange",
          "commitMessage": "HADOOP-13164 Optimize S3AFileSystem::deleteUnnecessaryFakeDirectories. Contributed by Rajesh Balamohan.\n",
          "commitDate": "29/09/16 9:01 AM",
          "commitName": "ee0c722dc8fb81ec902cd1da5958ce5adb0ab08f",
          "commitAuthor": "Steve Loughran",
          "commitDateOld": "28/09/16 4:19 PM",
          "commitNameOld": "47f80922dc7cb2fa6d084e6fb1f354c4ec1d4c69",
          "commitAuthorOld": "Chris Nauroth",
          "daysBetweenCommits": 0.7,
          "commitsBetweenForRepo": 4,
          "commitsBetweenForFile": 1,
          "diff": "@@ -1,27 +1,21 @@\n-  private void deleteUnnecessaryFakeDirectories(Path f) {\n-    while (true) {\n-      String key \u003d \"\";\n-      try {\n-        key \u003d pathToKey(f);\n-        if (key.isEmpty()) {\n-          break;\n+  private void deleteUnnecessaryFakeDirectories(Path path) {\n+    List\u003cDeleteObjectsRequest.KeyVersion\u003e keysToRemove \u003d new ArrayList\u003c\u003e();\n+    while (!path.isRoot()) {\n+      String key \u003d pathToKey(path);\n+      key \u003d (key.endsWith(\"/\")) ? key : (key + \"/\");\n+      keysToRemove.add(new DeleteObjectsRequest.KeyVersion(key));\n+      path \u003d path.getParent();\n+    }\n+    try {\n+      removeKeys(keysToRemove, false, true);\n+    } catch(AmazonClientException e) {\n+      instrumentation.errorIgnored();\n+      if (LOG.isDebugEnabled()) {\n+        StringBuilder sb \u003d new StringBuilder();\n+        for(DeleteObjectsRequest.KeyVersion kv : keysToRemove) {\n+          sb.append(kv.getKey()).append(\",\");\n         }\n-\n-        S3AFileStatus status \u003d getFileStatus(f);\n-\n-        if (status.isDirectory() \u0026\u0026 status.isEmptyDirectory()) {\n-          LOG.debug(\"Deleting fake directory {}/\", key);\n-          deleteObject(key + \"/\");\n-        }\n-      } catch (IOException | AmazonClientException e) {\n-        LOG.debug(\"While deleting key {} \", key, e);\n-        instrumentation.errorIgnored();\n+        LOG.debug(\"While deleting keys {} \", sb.toString(), e);\n       }\n-\n-      if (f.isRoot()) {\n-        break;\n-      }\n-\n-      f \u003d f.getParent();\n     }\n   }\n\\ No newline at end of file\n",
          "actualSource": "  private void deleteUnnecessaryFakeDirectories(Path path) {\n    List\u003cDeleteObjectsRequest.KeyVersion\u003e keysToRemove \u003d new ArrayList\u003c\u003e();\n    while (!path.isRoot()) {\n      String key \u003d pathToKey(path);\n      key \u003d (key.endsWith(\"/\")) ? key : (key + \"/\");\n      keysToRemove.add(new DeleteObjectsRequest.KeyVersion(key));\n      path \u003d path.getParent();\n    }\n    try {\n      removeKeys(keysToRemove, false, true);\n    } catch(AmazonClientException e) {\n      instrumentation.errorIgnored();\n      if (LOG.isDebugEnabled()) {\n        StringBuilder sb \u003d new StringBuilder();\n        for(DeleteObjectsRequest.KeyVersion kv : keysToRemove) {\n          sb.append(kv.getKey()).append(\",\");\n        }\n        LOG.debug(\"While deleting keys {} \", sb.toString(), e);\n      }\n    }\n  }",
          "path": "hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/S3AFileSystem.java",
          "extendedDetails": {
            "oldValue": "[f-Path]",
            "newValue": "[path-Path]"
          }
        },
        {
          "type": "Ybodychange",
          "commitMessage": "HADOOP-13164 Optimize S3AFileSystem::deleteUnnecessaryFakeDirectories. Contributed by Rajesh Balamohan.\n",
          "commitDate": "29/09/16 9:01 AM",
          "commitName": "ee0c722dc8fb81ec902cd1da5958ce5adb0ab08f",
          "commitAuthor": "Steve Loughran",
          "commitDateOld": "28/09/16 4:19 PM",
          "commitNameOld": "47f80922dc7cb2fa6d084e6fb1f354c4ec1d4c69",
          "commitAuthorOld": "Chris Nauroth",
          "daysBetweenCommits": 0.7,
          "commitsBetweenForRepo": 4,
          "commitsBetweenForFile": 1,
          "diff": "@@ -1,27 +1,21 @@\n-  private void deleteUnnecessaryFakeDirectories(Path f) {\n-    while (true) {\n-      String key \u003d \"\";\n-      try {\n-        key \u003d pathToKey(f);\n-        if (key.isEmpty()) {\n-          break;\n+  private void deleteUnnecessaryFakeDirectories(Path path) {\n+    List\u003cDeleteObjectsRequest.KeyVersion\u003e keysToRemove \u003d new ArrayList\u003c\u003e();\n+    while (!path.isRoot()) {\n+      String key \u003d pathToKey(path);\n+      key \u003d (key.endsWith(\"/\")) ? key : (key + \"/\");\n+      keysToRemove.add(new DeleteObjectsRequest.KeyVersion(key));\n+      path \u003d path.getParent();\n+    }\n+    try {\n+      removeKeys(keysToRemove, false, true);\n+    } catch(AmazonClientException e) {\n+      instrumentation.errorIgnored();\n+      if (LOG.isDebugEnabled()) {\n+        StringBuilder sb \u003d new StringBuilder();\n+        for(DeleteObjectsRequest.KeyVersion kv : keysToRemove) {\n+          sb.append(kv.getKey()).append(\",\");\n         }\n-\n-        S3AFileStatus status \u003d getFileStatus(f);\n-\n-        if (status.isDirectory() \u0026\u0026 status.isEmptyDirectory()) {\n-          LOG.debug(\"Deleting fake directory {}/\", key);\n-          deleteObject(key + \"/\");\n-        }\n-      } catch (IOException | AmazonClientException e) {\n-        LOG.debug(\"While deleting key {} \", key, e);\n-        instrumentation.errorIgnored();\n+        LOG.debug(\"While deleting keys {} \", sb.toString(), e);\n       }\n-\n-      if (f.isRoot()) {\n-        break;\n-      }\n-\n-      f \u003d f.getParent();\n     }\n   }\n\\ No newline at end of file\n",
          "actualSource": "  private void deleteUnnecessaryFakeDirectories(Path path) {\n    List\u003cDeleteObjectsRequest.KeyVersion\u003e keysToRemove \u003d new ArrayList\u003c\u003e();\n    while (!path.isRoot()) {\n      String key \u003d pathToKey(path);\n      key \u003d (key.endsWith(\"/\")) ? key : (key + \"/\");\n      keysToRemove.add(new DeleteObjectsRequest.KeyVersion(key));\n      path \u003d path.getParent();\n    }\n    try {\n      removeKeys(keysToRemove, false, true);\n    } catch(AmazonClientException e) {\n      instrumentation.errorIgnored();\n      if (LOG.isDebugEnabled()) {\n        StringBuilder sb \u003d new StringBuilder();\n        for(DeleteObjectsRequest.KeyVersion kv : keysToRemove) {\n          sb.append(kv.getKey()).append(\",\");\n        }\n        LOG.debug(\"While deleting keys {} \", sb.toString(), e);\n      }\n    }\n  }",
          "path": "hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/S3AFileSystem.java",
          "extendedDetails": {}
        }
      ]
    },
    "c58a59f7081d55dd2108545ebf9ee48cf43ca944": {
      "type": "Ybodychange",
      "commitMessage": "HADOOP-13171. Add StorageStatistics to S3A; instrument some more operations. Contributed by Steve Loughran.\n",
      "commitDate": "03/06/16 8:55 AM",
      "commitName": "c58a59f7081d55dd2108545ebf9ee48cf43ca944",
      "commitAuthor": "Chris Nauroth",
      "commitDateOld": "01/06/16 2:49 PM",
      "commitNameOld": "16b1cc7af9bd63b65ef50e1056f275a7baf111a2",
      "commitAuthorOld": "Chris Nauroth",
      "daysBetweenCommits": 1.75,
      "commitsBetweenForRepo": 8,
      "commitsBetweenForFile": 1,
      "diff": "@@ -1,28 +1,27 @@\n   private void deleteUnnecessaryFakeDirectories(Path f) {\n     while (true) {\n       String key \u003d \"\";\n       try {\n         key \u003d pathToKey(f);\n         if (key.isEmpty()) {\n           break;\n         }\n \n         S3AFileStatus status \u003d getFileStatus(f);\n \n         if (status.isDirectory() \u0026\u0026 status.isEmptyDirectory()) {\n           LOG.debug(\"Deleting fake directory {}/\", key);\n-          s3.deleteObject(bucket, key + \"/\");\n-          statistics.incrementWriteOps(1);\n+          deleteObject(key + \"/\");\n         }\n       } catch (IOException | AmazonClientException e) {\n         LOG.debug(\"While deleting key {} \", key, e);\n         instrumentation.errorIgnored();\n       }\n \n       if (f.isRoot()) {\n         break;\n       }\n \n       f \u003d f.getParent();\n     }\n   }\n\\ No newline at end of file\n",
      "actualSource": "  private void deleteUnnecessaryFakeDirectories(Path f) {\n    while (true) {\n      String key \u003d \"\";\n      try {\n        key \u003d pathToKey(f);\n        if (key.isEmpty()) {\n          break;\n        }\n\n        S3AFileStatus status \u003d getFileStatus(f);\n\n        if (status.isDirectory() \u0026\u0026 status.isEmptyDirectory()) {\n          LOG.debug(\"Deleting fake directory {}/\", key);\n          deleteObject(key + \"/\");\n        }\n      } catch (IOException | AmazonClientException e) {\n        LOG.debug(\"While deleting key {} \", key, e);\n        instrumentation.errorIgnored();\n      }\n\n      if (f.isRoot()) {\n        break;\n      }\n\n      f \u003d f.getParent();\n    }\n  }",
      "path": "hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/S3AFileSystem.java",
      "extendedDetails": {}
    },
    "39ec1515a205952eda7e171408a8b83eceb4abde": {
      "type": "Ymultichange(Yexceptionschange,Ybodychange)",
      "commitMessage": "HADOOP-13130. s3a failures can surface as RTEs, not IOEs. (Steve Loughran)\n",
      "commitDate": "21/05/16 8:39 AM",
      "commitName": "39ec1515a205952eda7e171408a8b83eceb4abde",
      "commitAuthor": "Steve Loughran",
      "subchanges": [
        {
          "type": "Yexceptionschange",
          "commitMessage": "HADOOP-13130. s3a failures can surface as RTEs, not IOEs. (Steve Loughran)\n",
          "commitDate": "21/05/16 8:39 AM",
          "commitName": "39ec1515a205952eda7e171408a8b83eceb4abde",
          "commitAuthor": "Steve Loughran",
          "commitDateOld": "20/05/16 5:52 AM",
          "commitNameOld": "757050ff355d40bc28f9dbfd0c0083c5f337d270",
          "commitAuthorOld": "Steve Loughran",
          "daysBetweenCommits": 1.12,
          "commitsBetweenForRepo": 4,
          "commitsBetweenForFile": 1,
          "diff": "@@ -1,28 +1,28 @@\n-  private void deleteUnnecessaryFakeDirectories(Path f) throws IOException {\n+  private void deleteUnnecessaryFakeDirectories(Path f) {\n     while (true) {\n       String key \u003d \"\";\n       try {\n         key \u003d pathToKey(f);\n         if (key.isEmpty()) {\n           break;\n         }\n \n         S3AFileStatus status \u003d getFileStatus(f);\n \n         if (status.isDirectory() \u0026\u0026 status.isEmptyDirectory()) {\n           LOG.debug(\"Deleting fake directory {}/\", key);\n           s3.deleteObject(bucket, key + \"/\");\n           statistics.incrementWriteOps(1);\n         }\n-      } catch (FileNotFoundException | AmazonServiceException e) {\n+      } catch (IOException | AmazonClientException e) {\n         LOG.debug(\"While deleting key {} \", key, e);\n         instrumentation.errorIgnored();\n       }\n \n       if (f.isRoot()) {\n         break;\n       }\n \n       f \u003d f.getParent();\n     }\n   }\n\\ No newline at end of file\n",
          "actualSource": "  private void deleteUnnecessaryFakeDirectories(Path f) {\n    while (true) {\n      String key \u003d \"\";\n      try {\n        key \u003d pathToKey(f);\n        if (key.isEmpty()) {\n          break;\n        }\n\n        S3AFileStatus status \u003d getFileStatus(f);\n\n        if (status.isDirectory() \u0026\u0026 status.isEmptyDirectory()) {\n          LOG.debug(\"Deleting fake directory {}/\", key);\n          s3.deleteObject(bucket, key + \"/\");\n          statistics.incrementWriteOps(1);\n        }\n      } catch (IOException | AmazonClientException e) {\n        LOG.debug(\"While deleting key {} \", key, e);\n        instrumentation.errorIgnored();\n      }\n\n      if (f.isRoot()) {\n        break;\n      }\n\n      f \u003d f.getParent();\n    }\n  }",
          "path": "hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/S3AFileSystem.java",
          "extendedDetails": {
            "oldValue": "[IOException]",
            "newValue": "[]"
          }
        },
        {
          "type": "Ybodychange",
          "commitMessage": "HADOOP-13130. s3a failures can surface as RTEs, not IOEs. (Steve Loughran)\n",
          "commitDate": "21/05/16 8:39 AM",
          "commitName": "39ec1515a205952eda7e171408a8b83eceb4abde",
          "commitAuthor": "Steve Loughran",
          "commitDateOld": "20/05/16 5:52 AM",
          "commitNameOld": "757050ff355d40bc28f9dbfd0c0083c5f337d270",
          "commitAuthorOld": "Steve Loughran",
          "daysBetweenCommits": 1.12,
          "commitsBetweenForRepo": 4,
          "commitsBetweenForFile": 1,
          "diff": "@@ -1,28 +1,28 @@\n-  private void deleteUnnecessaryFakeDirectories(Path f) throws IOException {\n+  private void deleteUnnecessaryFakeDirectories(Path f) {\n     while (true) {\n       String key \u003d \"\";\n       try {\n         key \u003d pathToKey(f);\n         if (key.isEmpty()) {\n           break;\n         }\n \n         S3AFileStatus status \u003d getFileStatus(f);\n \n         if (status.isDirectory() \u0026\u0026 status.isEmptyDirectory()) {\n           LOG.debug(\"Deleting fake directory {}/\", key);\n           s3.deleteObject(bucket, key + \"/\");\n           statistics.incrementWriteOps(1);\n         }\n-      } catch (FileNotFoundException | AmazonServiceException e) {\n+      } catch (IOException | AmazonClientException e) {\n         LOG.debug(\"While deleting key {} \", key, e);\n         instrumentation.errorIgnored();\n       }\n \n       if (f.isRoot()) {\n         break;\n       }\n \n       f \u003d f.getParent();\n     }\n   }\n\\ No newline at end of file\n",
          "actualSource": "  private void deleteUnnecessaryFakeDirectories(Path f) {\n    while (true) {\n      String key \u003d \"\";\n      try {\n        key \u003d pathToKey(f);\n        if (key.isEmpty()) {\n          break;\n        }\n\n        S3AFileStatus status \u003d getFileStatus(f);\n\n        if (status.isDirectory() \u0026\u0026 status.isEmptyDirectory()) {\n          LOG.debug(\"Deleting fake directory {}/\", key);\n          s3.deleteObject(bucket, key + \"/\");\n          statistics.incrementWriteOps(1);\n        }\n      } catch (IOException | AmazonClientException e) {\n        LOG.debug(\"While deleting key {} \", key, e);\n        instrumentation.errorIgnored();\n      }\n\n      if (f.isRoot()) {\n        break;\n      }\n\n      f \u003d f.getParent();\n    }\n  }",
          "path": "hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/S3AFileSystem.java",
          "extendedDetails": {}
        }
      ]
    },
    "27c4e90efce04e1b1302f668b5eb22412e00d033": {
      "type": "Ybodychange",
      "commitMessage": "HADOOP-13028 add low level counter metrics for S3A; use in read performance tests. contributed by: stevel\npatch includes\nHADOOP-12844 Recover when S3A fails on IOException in read()\nHADOOP-13058 S3A FS fails during init against a read-only FS if multipart purge\nHADOOP-13047 S3a Forward seek in stream length to be configurable\n",
      "commitDate": "12/05/16 11:24 AM",
      "commitName": "27c4e90efce04e1b1302f668b5eb22412e00d033",
      "commitAuthor": "Steve Loughran",
      "commitDateOld": "12/05/16 5:57 AM",
      "commitNameOld": "def2a6d3856452d5c804f04e5bf485541a3bc53a",
      "commitAuthorOld": "Steve Loughran",
      "daysBetweenCommits": 0.23,
      "commitsBetweenForRepo": 5,
      "commitsBetweenForFile": 1,
      "diff": "@@ -1,27 +1,28 @@\n   private void deleteUnnecessaryFakeDirectories(Path f) throws IOException {\n     while (true) {\n+      String key \u003d \"\";\n       try {\n-        String key \u003d pathToKey(f);\n+        key \u003d pathToKey(f);\n         if (key.isEmpty()) {\n           break;\n         }\n \n         S3AFileStatus status \u003d getFileStatus(f);\n \n         if (status.isDirectory() \u0026\u0026 status.isEmptyDirectory()) {\n-          if (LOG.isDebugEnabled()) {\n-            LOG.debug(\"Deleting fake directory \" + key + \"/\");\n-          }\n+          LOG.debug(\"Deleting fake directory {}/\", key);\n           s3.deleteObject(bucket, key + \"/\");\n           statistics.incrementWriteOps(1);\n         }\n       } catch (FileNotFoundException | AmazonServiceException e) {\n+        LOG.debug(\"While deleting key {} \", key, e);\n+        instrumentation.errorIgnored();\n       }\n \n       if (f.isRoot()) {\n         break;\n       }\n \n       f \u003d f.getParent();\n     }\n   }\n\\ No newline at end of file\n",
      "actualSource": "  private void deleteUnnecessaryFakeDirectories(Path f) throws IOException {\n    while (true) {\n      String key \u003d \"\";\n      try {\n        key \u003d pathToKey(f);\n        if (key.isEmpty()) {\n          break;\n        }\n\n        S3AFileStatus status \u003d getFileStatus(f);\n\n        if (status.isDirectory() \u0026\u0026 status.isEmptyDirectory()) {\n          LOG.debug(\"Deleting fake directory {}/\", key);\n          s3.deleteObject(bucket, key + \"/\");\n          statistics.incrementWriteOps(1);\n        }\n      } catch (FileNotFoundException | AmazonServiceException e) {\n        LOG.debug(\"While deleting key {} \", key, e);\n        instrumentation.errorIgnored();\n      }\n\n      if (f.isRoot()) {\n        break;\n      }\n\n      f \u003d f.getParent();\n    }\n  }",
      "path": "hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/S3AFileSystem.java",
      "extendedDetails": {}
    },
    "709ff99cff4124823bde631e272af7be9a22f83b": {
      "type": "Ybodychange",
      "commitMessage": "HADOOP-11584 s3a file block size set to 0 in getFileStatus. (Brahma Reddy Battula via stevel)\n",
      "commitDate": "21/02/15 4:03 AM",
      "commitName": "709ff99cff4124823bde631e272af7be9a22f83b",
      "commitAuthor": "Steve Loughran",
      "commitDateOld": "20/02/15 12:51 PM",
      "commitNameOld": "aa1c437b6a806de612f030a68984c606c623f1d9",
      "commitAuthorOld": "Steve Loughran",
      "daysBetweenCommits": 0.63,
      "commitsBetweenForRepo": 6,
      "commitsBetweenForFile": 1,
      "diff": "@@ -1,27 +1,27 @@\n   private void deleteUnnecessaryFakeDirectories(Path f) throws IOException {\n     while (true) {\n       try {\n         String key \u003d pathToKey(f);\n         if (key.isEmpty()) {\n           break;\n         }\n \n         S3AFileStatus status \u003d getFileStatus(f);\n \n         if (status.isDirectory() \u0026\u0026 status.isEmptyDirectory()) {\n           if (LOG.isDebugEnabled()) {\n             LOG.debug(\"Deleting fake directory \" + key + \"/\");\n           }\n           s3.deleteObject(bucket, key + \"/\");\n           statistics.incrementWriteOps(1);\n         }\n-      } catch (FileNotFoundException e) {\n-      } catch (AmazonServiceException e) {}\n+      } catch (FileNotFoundException | AmazonServiceException e) {\n+      }\n \n       if (f.isRoot()) {\n         break;\n       }\n \n       f \u003d f.getParent();\n     }\n   }\n\\ No newline at end of file\n",
      "actualSource": "  private void deleteUnnecessaryFakeDirectories(Path f) throws IOException {\n    while (true) {\n      try {\n        String key \u003d pathToKey(f);\n        if (key.isEmpty()) {\n          break;\n        }\n\n        S3AFileStatus status \u003d getFileStatus(f);\n\n        if (status.isDirectory() \u0026\u0026 status.isEmptyDirectory()) {\n          if (LOG.isDebugEnabled()) {\n            LOG.debug(\"Deleting fake directory \" + key + \"/\");\n          }\n          s3.deleteObject(bucket, key + \"/\");\n          statistics.incrementWriteOps(1);\n        }\n      } catch (FileNotFoundException | AmazonServiceException e) {\n      }\n\n      if (f.isRoot()) {\n        break;\n      }\n\n      f \u003d f.getParent();\n    }\n  }",
      "path": "hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/S3AFileSystem.java",
      "extendedDetails": {}
    },
    "24d920b80eb3626073925a1d0b6dcf148add8cc0": {
      "type": "Yintroduced",
      "commitMessage": "HADOOP-10400. Incorporate new S3A FileSystem implementation. Contributed by Jordan Mendelson and Dave Wang.\n",
      "commitDate": "15/09/14 8:27 AM",
      "commitName": "24d920b80eb3626073925a1d0b6dcf148add8cc0",
      "commitAuthor": "Aaron T. Myers",
      "diff": "@@ -0,0 +1,27 @@\n+  private void deleteUnnecessaryFakeDirectories(Path f) throws IOException {\n+    while (true) {\n+      try {\n+        String key \u003d pathToKey(f);\n+        if (key.isEmpty()) {\n+          break;\n+        }\n+\n+        S3AFileStatus status \u003d getFileStatus(f);\n+\n+        if (status.isDirectory() \u0026\u0026 status.isEmptyDirectory()) {\n+          if (LOG.isDebugEnabled()) {\n+            LOG.debug(\"Deleting fake directory \" + key + \"/\");\n+          }\n+          s3.deleteObject(bucket, key + \"/\");\n+          statistics.incrementWriteOps(1);\n+        }\n+      } catch (FileNotFoundException e) {\n+      } catch (AmazonServiceException e) {}\n+\n+      if (f.isRoot()) {\n+        break;\n+      }\n+\n+      f \u003d f.getParent();\n+    }\n+  }\n\\ No newline at end of file\n",
      "actualSource": "  private void deleteUnnecessaryFakeDirectories(Path f) throws IOException {\n    while (true) {\n      try {\n        String key \u003d pathToKey(f);\n        if (key.isEmpty()) {\n          break;\n        }\n\n        S3AFileStatus status \u003d getFileStatus(f);\n\n        if (status.isDirectory() \u0026\u0026 status.isEmptyDirectory()) {\n          if (LOG.isDebugEnabled()) {\n            LOG.debug(\"Deleting fake directory \" + key + \"/\");\n          }\n          s3.deleteObject(bucket, key + \"/\");\n          statistics.incrementWriteOps(1);\n        }\n      } catch (FileNotFoundException e) {\n      } catch (AmazonServiceException e) {}\n\n      if (f.isRoot()) {\n        break;\n      }\n\n      f \u003d f.getParent();\n    }\n  }",
      "path": "hadoop-tools/hadoop-aws/src/main/java/org/apache/hadoop/fs/s3a/S3AFileSystem.java"
    }
  }
}