{
  "origin": "codeshovel",
  "repositoryName": "hadoop",
  "repositoryPath": "/home/shaiful/research/codeshovel/codeshovel-projects/hadoop/.git",
  "startCommitName": "HEAD",
  "sourceFileName": "GpuNodeResourceUpdateHandler.java",
  "functionName": "updateConfiguredResource",
  "functionId": "updateConfiguredResource___res-Resource",
  "sourceFilePath": "hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-nodemanager/src/main/java/org/apache/hadoop/yarn/server/nodemanager/containermanager/resourceplugin/gpu/GpuNodeResourceUpdateHandler.java",
  "functionStartLine": 51,
  "functionEndLine": 78,
  "numCommitsSeen": 5,
  "timeTaken": 3166,
  "changeHistory": [
    "e8fa192f07b6f2e7a0b03813edca03c505a8ac1b",
    "5e91ebd91a405e1585ef02b8fbf03f10d1398adf",
    "95fbbfed75dd309b5d56032ece64996165572287",
    "9114d7a5a0159bbe70e9c289dbe1fc5db9101db5",
    "fa5cfc68f37c78b6cf26ce13247b9ff34da806cd"
  ],
  "changeHistoryShort": {
    "e8fa192f07b6f2e7a0b03813edca03c505a8ac1b": "Ybodychange",
    "5e91ebd91a405e1585ef02b8fbf03f10d1398adf": "Ybodychange",
    "95fbbfed75dd309b5d56032ece64996165572287": "Ybodychange",
    "9114d7a5a0159bbe70e9c289dbe1fc5db9101db5": "Ybodychange",
    "fa5cfc68f37c78b6cf26ce13247b9ff34da806cd": "Yintroduced"
  },
  "changeHistoryDetails": {
    "e8fa192f07b6f2e7a0b03813edca03c505a8ac1b": {
      "type": "Ybodychange",
      "commitMessage": "YARN-9217. Nodemanager will fail to start if GPU is misconfigured on the node or GPU drivers missing. Contributed by Peter Bacsko\n",
      "commitDate": "21/08/19 7:44 AM",
      "commitName": "e8fa192f07b6f2e7a0b03813edca03c505a8ac1b",
      "commitAuthor": "Szilard Nemeth",
      "commitDateOld": "24/02/19 10:00 PM",
      "commitNameOld": "5e91ebd91a405e1585ef02b8fbf03f10d1398adf",
      "commitAuthorOld": "Sunil G",
      "daysBetweenCommits": 177.36,
      "commitsBetweenForRepo": 1350,
      "commitsBetweenForFile": 1,
      "diff": "@@ -1,27 +1,28 @@\n   public void updateConfiguredResource(Resource res) throws YarnException {\n     LOG.info(\"Initializing configured GPU resources for the NodeManager.\");\n \n     List\u003cGpuDevice\u003e usableGpus \u003d gpuDiscoverer.getGpusUsableByYarn();\n     if (usableGpus \u003d\u003d null || usableGpus.isEmpty()) {\n       String message \u003d \"GPU is enabled, \" +\n           \"but could not find any usable GPUs on the NodeManager!\";\n       LOG.error(message);\n       // No gpu can be used by YARN.\n-      throw new YarnException(message);\n+      throwIfNecessary(new YarnException(message), conf);\n+      return;\n     }\n \n     long nUsableGpus \u003d usableGpus.size();\n \n     Map\u003cString, ResourceInformation\u003e configuredResourceTypes \u003d\n         ResourceUtils.getResourceTypes();\n     if (!configuredResourceTypes.containsKey(GPU_URI)) {\n-      throw new YarnException(\"Found \" + nUsableGpus + \" usable GPUs, however \"\n+      LOG.warn(\"Found \" + nUsableGpus + \" usable GPUs, however \"\n           + GPU_URI\n           + \" resource-type is not configured inside\"\n           + \" resource-types.xml, please configure it to enable GPU feature or\"\n           + \" remove \" + GPU_URI + \" from \"\n           + YarnConfiguration.NM_RESOURCE_PLUGINS);\n     }\n \n     res.setResourceValue(GPU_URI, nUsableGpus);\n   }\n\\ No newline at end of file\n",
      "actualSource": "  public void updateConfiguredResource(Resource res) throws YarnException {\n    LOG.info(\"Initializing configured GPU resources for the NodeManager.\");\n\n    List\u003cGpuDevice\u003e usableGpus \u003d gpuDiscoverer.getGpusUsableByYarn();\n    if (usableGpus \u003d\u003d null || usableGpus.isEmpty()) {\n      String message \u003d \"GPU is enabled, \" +\n          \"but could not find any usable GPUs on the NodeManager!\";\n      LOG.error(message);\n      // No gpu can be used by YARN.\n      throwIfNecessary(new YarnException(message), conf);\n      return;\n    }\n\n    long nUsableGpus \u003d usableGpus.size();\n\n    Map\u003cString, ResourceInformation\u003e configuredResourceTypes \u003d\n        ResourceUtils.getResourceTypes();\n    if (!configuredResourceTypes.containsKey(GPU_URI)) {\n      LOG.warn(\"Found \" + nUsableGpus + \" usable GPUs, however \"\n          + GPU_URI\n          + \" resource-type is not configured inside\"\n          + \" resource-types.xml, please configure it to enable GPU feature or\"\n          + \" remove \" + GPU_URI + \" from \"\n          + YarnConfiguration.NM_RESOURCE_PLUGINS);\n    }\n\n    res.setResourceValue(GPU_URI, nUsableGpus);\n  }",
      "path": "hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-nodemanager/src/main/java/org/apache/hadoop/yarn/server/nodemanager/containermanager/resourceplugin/gpu/GpuNodeResourceUpdateHandler.java",
      "extendedDetails": {}
    },
    "5e91ebd91a405e1585ef02b8fbf03f10d1398adf": {
      "type": "Ybodychange",
      "commitMessage": "YARN-9121. Replace GpuDiscoverer.getInstance() to a readable object for easy access control. Contributed by Szilard Nemeth.\n",
      "commitDate": "24/02/19 10:00 PM",
      "commitName": "5e91ebd91a405e1585ef02b8fbf03f10d1398adf",
      "commitAuthor": "Sunil G",
      "commitDateOld": "22/02/19 6:52 AM",
      "commitNameOld": "95fbbfed75dd309b5d56032ece64996165572287",
      "commitAuthorOld": "Sunil G",
      "daysBetweenCommits": 2.63,
      "commitsBetweenForRepo": 28,
      "commitsBetweenForFile": 1,
      "diff": "@@ -1,28 +1,27 @@\n   public void updateConfiguredResource(Resource res) throws YarnException {\n     LOG.info(\"Initializing configured GPU resources for the NodeManager.\");\n \n-    List\u003cGpuDevice\u003e usableGpus \u003d GpuDiscoverer.getInstance()\n-            .getGpusUsableByYarn();\n+    List\u003cGpuDevice\u003e usableGpus \u003d gpuDiscoverer.getGpusUsableByYarn();\n     if (usableGpus \u003d\u003d null || usableGpus.isEmpty()) {\n       String message \u003d \"GPU is enabled, \" +\n-              \"but couldn\u0027t find any usable GPUs on the NodeManager!\";\n+          \"but could not find any usable GPUs on the NodeManager!\";\n       LOG.error(message);\n       // No gpu can be used by YARN.\n       throw new YarnException(message);\n     }\n \n     long nUsableGpus \u003d usableGpus.size();\n \n     Map\u003cString, ResourceInformation\u003e configuredResourceTypes \u003d\n         ResourceUtils.getResourceTypes();\n     if (!configuredResourceTypes.containsKey(GPU_URI)) {\n       throw new YarnException(\"Found \" + nUsableGpus + \" usable GPUs, however \"\n           + GPU_URI\n           + \" resource-type is not configured inside\"\n           + \" resource-types.xml, please configure it to enable GPU feature or\"\n           + \" remove \" + GPU_URI + \" from \"\n           + YarnConfiguration.NM_RESOURCE_PLUGINS);\n     }\n \n     res.setResourceValue(GPU_URI, nUsableGpus);\n   }\n\\ No newline at end of file\n",
      "actualSource": "  public void updateConfiguredResource(Resource res) throws YarnException {\n    LOG.info(\"Initializing configured GPU resources for the NodeManager.\");\n\n    List\u003cGpuDevice\u003e usableGpus \u003d gpuDiscoverer.getGpusUsableByYarn();\n    if (usableGpus \u003d\u003d null || usableGpus.isEmpty()) {\n      String message \u003d \"GPU is enabled, \" +\n          \"but could not find any usable GPUs on the NodeManager!\";\n      LOG.error(message);\n      // No gpu can be used by YARN.\n      throw new YarnException(message);\n    }\n\n    long nUsableGpus \u003d usableGpus.size();\n\n    Map\u003cString, ResourceInformation\u003e configuredResourceTypes \u003d\n        ResourceUtils.getResourceTypes();\n    if (!configuredResourceTypes.containsKey(GPU_URI)) {\n      throw new YarnException(\"Found \" + nUsableGpus + \" usable GPUs, however \"\n          + GPU_URI\n          + \" resource-type is not configured inside\"\n          + \" resource-types.xml, please configure it to enable GPU feature or\"\n          + \" remove \" + GPU_URI + \" from \"\n          + YarnConfiguration.NM_RESOURCE_PLUGINS);\n    }\n\n    res.setResourceValue(GPU_URI, nUsableGpus);\n  }",
      "path": "hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-nodemanager/src/main/java/org/apache/hadoop/yarn/server/nodemanager/containermanager/resourceplugin/gpu/GpuNodeResourceUpdateHandler.java",
      "extendedDetails": {}
    },
    "95fbbfed75dd309b5d56032ece64996165572287": {
      "type": "Ybodychange",
      "commitMessage": "YARN-9118. Handle exceptions with parsing user defined GPU devices in GpuDiscoverer. Contributed by Szilard Nemeth.\n",
      "commitDate": "22/02/19 6:52 AM",
      "commitName": "95fbbfed75dd309b5d56032ece64996165572287",
      "commitAuthor": "Sunil G",
      "commitDateOld": "28/10/17 10:38 PM",
      "commitNameOld": "9114d7a5a0159bbe70e9c289dbe1fc5db9101db5",
      "commitAuthorOld": "Sunil G",
      "daysBetweenCommits": 481.38,
      "commitsBetweenForRepo": 4153,
      "commitsBetweenForFile": 1,
      "diff": "@@ -1,28 +1,28 @@\n   public void updateConfiguredResource(Resource res) throws YarnException {\n     LOG.info(\"Initializing configured GPU resources for the NodeManager.\");\n \n-    List\u003cGpuDevice\u003e usableGpus \u003d\n-        GpuDiscoverer.getInstance().getGpusUsableByYarn();\n-    if (null \u003d\u003d usableGpus || usableGpus.isEmpty()) {\n-      String message \u003d \"GPU is enabled, but couldn\u0027t find any usable GPUs on the \"\n-          + \"NodeManager.\";\n+    List\u003cGpuDevice\u003e usableGpus \u003d GpuDiscoverer.getInstance()\n+            .getGpusUsableByYarn();\n+    if (usableGpus \u003d\u003d null || usableGpus.isEmpty()) {\n+      String message \u003d \"GPU is enabled, \" +\n+              \"but couldn\u0027t find any usable GPUs on the NodeManager!\";\n       LOG.error(message);\n       // No gpu can be used by YARN.\n       throw new YarnException(message);\n     }\n \n     long nUsableGpus \u003d usableGpus.size();\n \n     Map\u003cString, ResourceInformation\u003e configuredResourceTypes \u003d\n         ResourceUtils.getResourceTypes();\n     if (!configuredResourceTypes.containsKey(GPU_URI)) {\n       throw new YarnException(\"Found \" + nUsableGpus + \" usable GPUs, however \"\n           + GPU_URI\n           + \" resource-type is not configured inside\"\n           + \" resource-types.xml, please configure it to enable GPU feature or\"\n           + \" remove \" + GPU_URI + \" from \"\n           + YarnConfiguration.NM_RESOURCE_PLUGINS);\n     }\n \n     res.setResourceValue(GPU_URI, nUsableGpus);\n   }\n\\ No newline at end of file\n",
      "actualSource": "  public void updateConfiguredResource(Resource res) throws YarnException {\n    LOG.info(\"Initializing configured GPU resources for the NodeManager.\");\n\n    List\u003cGpuDevice\u003e usableGpus \u003d GpuDiscoverer.getInstance()\n            .getGpusUsableByYarn();\n    if (usableGpus \u003d\u003d null || usableGpus.isEmpty()) {\n      String message \u003d \"GPU is enabled, \" +\n              \"but couldn\u0027t find any usable GPUs on the NodeManager!\";\n      LOG.error(message);\n      // No gpu can be used by YARN.\n      throw new YarnException(message);\n    }\n\n    long nUsableGpus \u003d usableGpus.size();\n\n    Map\u003cString, ResourceInformation\u003e configuredResourceTypes \u003d\n        ResourceUtils.getResourceTypes();\n    if (!configuredResourceTypes.containsKey(GPU_URI)) {\n      throw new YarnException(\"Found \" + nUsableGpus + \" usable GPUs, however \"\n          + GPU_URI\n          + \" resource-type is not configured inside\"\n          + \" resource-types.xml, please configure it to enable GPU feature or\"\n          + \" remove \" + GPU_URI + \" from \"\n          + YarnConfiguration.NM_RESOURCE_PLUGINS);\n    }\n\n    res.setResourceValue(GPU_URI, nUsableGpus);\n  }",
      "path": "hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-nodemanager/src/main/java/org/apache/hadoop/yarn/server/nodemanager/containermanager/resourceplugin/gpu/GpuNodeResourceUpdateHandler.java",
      "extendedDetails": {}
    },
    "9114d7a5a0159bbe70e9c289dbe1fc5db9101db5": {
      "type": "Ybodychange",
      "commitMessage": "YARN-7224. Support GPU isolation for docker container. Contributed by Wangda Tan.\n",
      "commitDate": "28/10/17 10:38 PM",
      "commitName": "9114d7a5a0159bbe70e9c289dbe1fc5db9101db5",
      "commitAuthor": "Sunil G",
      "commitDateOld": "11/10/17 11:14 AM",
      "commitNameOld": "fa5cfc68f37c78b6cf26ce13247b9ff34da806cd",
      "commitAuthorOld": "Sunil G",
      "daysBetweenCommits": 17.48,
      "commitsBetweenForRepo": 104,
      "commitsBetweenForFile": 1,
      "diff": "@@ -1,26 +1,28 @@\n   public void updateConfiguredResource(Resource res) throws YarnException {\n     LOG.info(\"Initializing configured GPU resources for the NodeManager.\");\n \n-    List\u003cInteger\u003e usableGpus \u003d\n-        GpuDiscoverer.getInstance().getMinorNumbersOfGpusUsableByYarn();\n+    List\u003cGpuDevice\u003e usableGpus \u003d\n+        GpuDiscoverer.getInstance().getGpusUsableByYarn();\n     if (null \u003d\u003d usableGpus || usableGpus.isEmpty()) {\n-      LOG.info(\"Didn\u0027t find any usable GPUs on the NodeManager.\");\n+      String message \u003d \"GPU is enabled, but couldn\u0027t find any usable GPUs on the \"\n+          + \"NodeManager.\";\n+      LOG.error(message);\n       // No gpu can be used by YARN.\n-      return;\n+      throw new YarnException(message);\n     }\n \n     long nUsableGpus \u003d usableGpus.size();\n \n     Map\u003cString, ResourceInformation\u003e configuredResourceTypes \u003d\n         ResourceUtils.getResourceTypes();\n     if (!configuredResourceTypes.containsKey(GPU_URI)) {\n       throw new YarnException(\"Found \" + nUsableGpus + \" usable GPUs, however \"\n           + GPU_URI\n           + \" resource-type is not configured inside\"\n           + \" resource-types.xml, please configure it to enable GPU feature or\"\n           + \" remove \" + GPU_URI + \" from \"\n           + YarnConfiguration.NM_RESOURCE_PLUGINS);\n     }\n \n     res.setResourceValue(GPU_URI, nUsableGpus);\n   }\n\\ No newline at end of file\n",
      "actualSource": "  public void updateConfiguredResource(Resource res) throws YarnException {\n    LOG.info(\"Initializing configured GPU resources for the NodeManager.\");\n\n    List\u003cGpuDevice\u003e usableGpus \u003d\n        GpuDiscoverer.getInstance().getGpusUsableByYarn();\n    if (null \u003d\u003d usableGpus || usableGpus.isEmpty()) {\n      String message \u003d \"GPU is enabled, but couldn\u0027t find any usable GPUs on the \"\n          + \"NodeManager.\";\n      LOG.error(message);\n      // No gpu can be used by YARN.\n      throw new YarnException(message);\n    }\n\n    long nUsableGpus \u003d usableGpus.size();\n\n    Map\u003cString, ResourceInformation\u003e configuredResourceTypes \u003d\n        ResourceUtils.getResourceTypes();\n    if (!configuredResourceTypes.containsKey(GPU_URI)) {\n      throw new YarnException(\"Found \" + nUsableGpus + \" usable GPUs, however \"\n          + GPU_URI\n          + \" resource-type is not configured inside\"\n          + \" resource-types.xml, please configure it to enable GPU feature or\"\n          + \" remove \" + GPU_URI + \" from \"\n          + YarnConfiguration.NM_RESOURCE_PLUGINS);\n    }\n\n    res.setResourceValue(GPU_URI, nUsableGpus);\n  }",
      "path": "hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-nodemanager/src/main/java/org/apache/hadoop/yarn/server/nodemanager/containermanager/resourceplugin/gpu/GpuNodeResourceUpdateHandler.java",
      "extendedDetails": {}
    },
    "fa5cfc68f37c78b6cf26ce13247b9ff34da806cd": {
      "type": "Yintroduced",
      "commitMessage": "YARN-6620. Add support in NodeManager to isolate GPU devices by using CGroups. Contributed by Wangda Tan.\n",
      "commitDate": "11/10/17 11:14 AM",
      "commitName": "fa5cfc68f37c78b6cf26ce13247b9ff34da806cd",
      "commitAuthor": "Sunil G",
      "diff": "@@ -0,0 +1,26 @@\n+  public void updateConfiguredResource(Resource res) throws YarnException {\n+    LOG.info(\"Initializing configured GPU resources for the NodeManager.\");\n+\n+    List\u003cInteger\u003e usableGpus \u003d\n+        GpuDiscoverer.getInstance().getMinorNumbersOfGpusUsableByYarn();\n+    if (null \u003d\u003d usableGpus || usableGpus.isEmpty()) {\n+      LOG.info(\"Didn\u0027t find any usable GPUs on the NodeManager.\");\n+      // No gpu can be used by YARN.\n+      return;\n+    }\n+\n+    long nUsableGpus \u003d usableGpus.size();\n+\n+    Map\u003cString, ResourceInformation\u003e configuredResourceTypes \u003d\n+        ResourceUtils.getResourceTypes();\n+    if (!configuredResourceTypes.containsKey(GPU_URI)) {\n+      throw new YarnException(\"Found \" + nUsableGpus + \" usable GPUs, however \"\n+          + GPU_URI\n+          + \" resource-type is not configured inside\"\n+          + \" resource-types.xml, please configure it to enable GPU feature or\"\n+          + \" remove \" + GPU_URI + \" from \"\n+          + YarnConfiguration.NM_RESOURCE_PLUGINS);\n+    }\n+\n+    res.setResourceValue(GPU_URI, nUsableGpus);\n+  }\n\\ No newline at end of file\n",
      "actualSource": "  public void updateConfiguredResource(Resource res) throws YarnException {\n    LOG.info(\"Initializing configured GPU resources for the NodeManager.\");\n\n    List\u003cInteger\u003e usableGpus \u003d\n        GpuDiscoverer.getInstance().getMinorNumbersOfGpusUsableByYarn();\n    if (null \u003d\u003d usableGpus || usableGpus.isEmpty()) {\n      LOG.info(\"Didn\u0027t find any usable GPUs on the NodeManager.\");\n      // No gpu can be used by YARN.\n      return;\n    }\n\n    long nUsableGpus \u003d usableGpus.size();\n\n    Map\u003cString, ResourceInformation\u003e configuredResourceTypes \u003d\n        ResourceUtils.getResourceTypes();\n    if (!configuredResourceTypes.containsKey(GPU_URI)) {\n      throw new YarnException(\"Found \" + nUsableGpus + \" usable GPUs, however \"\n          + GPU_URI\n          + \" resource-type is not configured inside\"\n          + \" resource-types.xml, please configure it to enable GPU feature or\"\n          + \" remove \" + GPU_URI + \" from \"\n          + YarnConfiguration.NM_RESOURCE_PLUGINS);\n    }\n\n    res.setResourceValue(GPU_URI, nUsableGpus);\n  }",
      "path": "hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-nodemanager/src/main/java/org/apache/hadoop/yarn/server/nodemanager/containermanager/resourceplugin/gpu/GpuNodeResourceUpdateHandler.java"
    }
  }
}